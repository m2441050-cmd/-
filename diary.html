<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Couple Timeline</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  max-width:900px;margin:auto;padding:12px;background:#f6f2ff
}
h1{font-size:20px}
.card{
  background:#fff;border-radius:14px;padding:12px;margin:10px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.06)
}
textarea,input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc}
button{padding:6px 12px;border-radius:999px;border:none;background:#7b6cff;color:#fff}
button.ghost{background:#fff;color:#333;border:1px solid #ddd}
.muted{font-size:12px;opacity:.7}
.reply{margin-left:20px;border-left:3px solid #eee;padding-left:10px}
img{max-width:100%;border-radius:10px;margin-top:6px}
.actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
</style>
</head>

<body>

<h1>ğŸ’‘ Couple Timeline</h1>

<div class="card">
  <textarea id="postText" placeholder="ã¤ã¶ã‚„ã / æ—¥è¨˜ã«è¿”ä¿¡ / ã¤ã¶ã‚„ãã«è¿”ä¿¡"></textarea>
  <div class="muted" id="replyInfo"></div>
  <button onclick="post()">æŠ•ç¨¿</button>
  <button class="ghost" onclick="cancelReply()">è¿”ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<div class="card">
  <label class="muted">ğŸ“… æœˆã§çµã‚Šè¾¼ã¿</label>
  <input type="month" id="month">
</div>

<div id="timeline"></div>

<script>
const sb = supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);
const COUPLE_ID = "kentaria";

let replyTarget = null; // { type: 'tweet'|'diary', id }

function esc(s){return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

function monthRange(m){
  if(!m){
    const d=new Date();
    m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  const [y,mm]=m.split("-");
  return {start:`${y}-${mm}-01`, end:`${y}-${mm}-31`};
}

function startReply(type,id){
  replyTarget={type,id};
  replyInfo.textContent=`â†© ${type==="diary"?"æ—¥è¨˜":"ã¤ã¶ã‚„ã"}ã¸ã®è¿”ä¿¡ä¸­`;
  postText.focus();
}

function cancelReply(){
  replyTarget=null;
  replyInfo.textContent="";
}

async function post(){
  const body=postText.value.trim();
  if(!body) return;

  if(replyTarget){
    if(replyTarget.type==="tweet"){
      await sb.from("tweets").insert([{couple_id:COUPLE_ID,body,parent_id:replyTarget.id}]);
    }else{
      await sb.from("tweets").insert([{couple_id:COUPLE_ID,body,parent_id:null,reply_diary_id:replyTarget.id}]);
    }
  }else{
    await sb.from("tweets").insert([{couple_id:COUPLE_ID,body}]);
  }

  postText.value="";
  cancelReply();
  load();
}

async function toggleLike(type,id){
  const { data } = await sb.from("likes")
    .select("*").eq("couple_id",COUPLE_ID)
    .eq("target_type",type).eq("target_id",id).maybeSingle();

  if(data) await sb.from("likes").delete().eq("id",data.id);
  else await sb.from("likes").insert([{couple_id:COUPLE_ID,target_type:type,target_id:id}]);

  load();
}

async function load(){
  timeline.innerHTML="èª­ã¿è¾¼ã¿ä¸­â€¦";
  const {start,end}=monthRange(month.value);

  const { data: diaries } = await sb.from("diaries")
    .select("*").eq("couple_id",COUPLE_ID)
    .gte("date",start).lte("date",end);

  const { data: tweets } = await sb.from("tweets")
    .select("*").eq("couple_id",COUPLE_ID);

  const { data: likes } = await sb.from("likes")
    .select("*").eq("couple_id",COUPLE_ID);

  const likeMap={};
  (likes||[]).forEach(l=>likeMap[l.target_type+"_"+l.target_id]=(likeMap[l.target_type+"_"+l.target_id]||0)+1);

  const items=[
    ...(diaries||[]).map(d=>({...d,type:"diary",created_at:d.created_at})),
    ...(tweets||[]).map(t=>({...t,type:"tweet"}))
  ].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  timeline.innerHTML="";
  items.forEach(it=>{
    const key=it.type+"_"+it.id;
    const div=document.createElement("div");
    div.className="card"+(it.parent_id?" reply":"");
    div.innerHTML=`
      <div class="muted">${it.type==="diary"?"ğŸ“” æ—¥è¨˜":"ğŸ•Šï¸ ã¤ã¶ã‚„ã"}</div>
      <b>${esc(it.title||"")}</b>
      <div>${esc(it.body||"")}</div>
      ${it.image_url?`<img src="${it.image_url}">`:""}
      <div class="actions">
        <button onclick="toggleLike('${it.type}',${it.id})">â™¥ ${likeMap[key]||0}</button>
        <button class="ghost" onclick="startReply('${it.type}',${it.id})">è¿”ä¿¡</button>
      </div>
    `;
    timeline.appendChild(div);
  });
}

month.onchange=load;
load();
</script>
</body>
</html>
