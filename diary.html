<!doctype html>
<html lang="ja">
<head>
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Couple Timeline</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;max-width:900px;margin:auto;padding:12px;background:#f6f2ff}
  .card{background:#fff;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  textarea,input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc}
  button{padding:6px 12px;border-radius:999px;border:none;background:#7b6cff;color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:#333;border:1px solid #ddd}
  button.danger{background:#ff4d6d}
  .muted{font-size:12px;opacity:.7}
  .actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center}
  .reply{margin-left:20px;border-left:3px solid #eee;padding-left:10px}
  img{max-width:100%;border-radius:10px;margin-top:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grow{flex:1}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid #e9e3ff;border-radius:999px;background:#faf8ff;font-size:12px}
  .sep{height:1px;background:#f0f0f0;margin:10px 0}
  .error{color:#b00020;font-size:12px;margin-top:6px;white-space:pre-wrap}
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .time{font-size:12px;opacity:.7}
</style>
</head>

<body>
<h1>ğŸ’‘ Couple Timeline</h1>

<div class="card">
  <textarea id="postText" placeholder="ã¤ã¶ã‚„ã / è¿”ä¿¡ã™ã‚‹"></textarea>

  <div class="row" style="margin-top:8px">
    <input class="grow" id="imageUrl" placeholder="ç”»åƒURLï¼ˆhttps://...jpg/png/webpï¼‰ â€»ä»»æ„" />
  </div>

  <div class="meta" style="margin-top:8px">
    <span class="pill" id="replyInfo" style="display:none"></span>
    <span class="muted" id="status"></span>
  </div>

  <div class="actions">
    <button id="postBtn">æŠ•ç¨¿</button>
    <button class="ghost" id="cancelReplyBtn">è¿”ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="ghost" id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
  </div>

  <div class="error" id="err"></div>
</div>

<div class="card">
  <label class="muted">ğŸ“… æœˆã§çµã‚Šè¾¼ã¿</label>
  <input type="month" id="month" />
</div>

<div id="timeline"></div>

<script>
/** ===========
 *  è¨­å®š
 *  =========== */
const sb = supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);
const COUPLE_ID = "kentaria";

/** ===========
 *  çŠ¶æ…‹
 *  =========== */
let replyTarget = null; // { type: 'tweet'|'diary', id: number }

/** ===========
 *  DOM
 *  =========== */
const postText = document.getElementById("postText");
const imageUrl = document.getElementById("imageUrl");
const replyInfo = document.getElementById("replyInfo");
const statusEl = document.getElementById("status");
const errEl = document.getElementById("err");
const timeline = document.getElementById("timeline");
const month = document.getElementById("month");
const postBtn = document.getElementById("postBtn");
const cancelReplyBtn = document.getElementById("cancelReplyBtn");
const reloadBtn = document.getElementById("reloadBtn");

/** ===========
 *  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 *  =========== */
function esc(s){
  return (s || "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function fmtTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${y}/${m}/${da} ${hh}:${mm}`;
}

function setStatus(msg){
  statusEl.textContent = msg || "";
}

function setError(msg){
  errEl.textContent = msg || "";
}

function getMonthValueOrNow(){
  if(month.value) return month.value;
  const d = new Date();
  const v = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  month.value = v;
  return v;
}

// æœˆã®é–‹å§‹ãƒ»çµ‚äº†(æ¬¡æœˆã®1æ—¥æœªæº€)ã‚’æ­£ã—ãä½œã‚‹
function monthRange(monthStr){
  const [y, m] = monthStr.split("-").map(Number);
  const start = new Date(y, m-1, 1, 0, 0, 0);
  const endExclusive = new Date(y, m, 1, 0, 0, 0); // æ¬¡æœˆã®1æ—¥
  return {
    startISO: start.toISOString(),
    endISO: endExclusive.toISOString(),
    // dateå‹(YYYY-MM-DD)ç”¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œã‚‹
    startDate: `${y}-${String(m).padStart(2,"0")}-01`,
    endDate: (() => {
      const last = new Date(y, m, 0); // å½“æœˆæœ«æ—¥
      return `${y}-${String(m).padStart(2,"0")}-${String(last.getDate()).padStart(2,"0")}`;
    })()
  };
}

function isValidHttpUrl(url){
  try{
    const u = new URL(url);
    return u.protocol === "http:" || u.protocol === "https:";
  }catch(e){
    return false;
  }
}

function startReply(type, id){
  replyTarget = { type, id };
  replyInfo.style.display = "inline-flex";
  replyInfo.textContent = `â†© ${type === "diary" ? "æ—¥è¨˜" : "ã¤ã¶ã‚„ã"}ã¸ã®è¿”ä¿¡ä¸­ (#${id})`;
  postText.focus();
}

function cancelReply(){
  replyTarget = null;
  replyInfo.textContent = "";
  replyInfo.style.display = "none";
}

async function safeQuery(promise){
  const { data, error } = await promise;
  if(error) throw error;
  return data;
}

/** ===========
 *  æŠ•ç¨¿
 *  =========== */
async function post(){
  setError("");
  const body = postText.value.trim();
  const img = imageUrl.value.trim();

  if(!body){
    setError("æœ¬æ–‡ãŒç©ºã§ã™ã€‚");
    return;
  }

  let image_url = null;
  if(img){
    if(!isValidHttpUrl(img)){
      setError("ç”»åƒURLãŒä¸æ­£ã§ã™ï¼ˆhttp/https ã®URLã«ã—ã¦ãã ã•ã„ï¼‰ã€‚");
      return;
    }
    image_url = img;
  }

  postBtn.disabled = true;
  setStatus("æŠ•ç¨¿ä¸­â€¦");

  try{
    const row = {
      couple_id: COUPLE_ID,
      body,
      image_url,                // â˜…ã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã§ã¯ã“ã“ãŒæœªåæ˜ ã§ã—ãŸ
      parent_id: null,
      reply_diary_id: null
    };

    if(replyTarget){
      if(replyTarget.type === "tweet") row.parent_id = replyTarget.id;
      if(replyTarget.type === "diary") row.reply_diary_id = replyTarget.id;
    }

    await safeQuery(
      sb.from("tweets").insert([row])
    );

    postText.value = "";
    imageUrl.value = "";
    cancelReply();
    setStatus("æŠ•ç¨¿ã—ã¾ã—ãŸ");
    await load();
  }catch(e){
    setError(`æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${e.message || e}`);
  }finally{
    postBtn.disabled = false;
    setStatus("");
  }
}

/** ===========
 *  æç”»
 *  =========== */
// ãƒ„ã‚¤ãƒ¼ãƒˆã®è¿”ä¿¡ï¼ˆparent_idï¼‰ã‚’ãƒ„ãƒªãƒ¼åŒ–
function buildTweetTree(tweets){
  const byId = new Map();
  tweets.forEach(t => {
    byId.set(t.id, { ...t, replies: [] });
  });

  const roots = [];
  byId.forEach(node => {
    if(node.parent_id && byId.has(node.parent_id)){
      byId.get(node.parent_id).replies.push(node);
    }else{
      roots.push(node);
    }
  });

  // replies ã‚‚å«ã‚ã¦æ–°ã—ã„é †ã«
  function sortRec(arr){
    arr.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    arr.forEach(x => sortRec(x.replies));
  }
  sortRec(roots);

  return roots;
}

function renderTweetNode(node, depth=0){
  const div = document.createElement("div");
  div.className = "card" + (depth>0 ? " reply" : "");
  div.innerHTML = `
    <div class="meta">
      <div class="muted">ğŸ•Šï¸ ã¤ã¶ã‚„ã</div>
      <div class="time">${fmtTime(node.created_at)}</div>
      <div class="muted">#${node.id}</div>
    </div>
    <div style="margin-top:6px">${esc(node.body || "")}</div>
    ${node.image_url ? `<img src="${esc(node.image_url)}" alt="image">` : ""}
    <div class="actions">
      <button class="ghost" onclick="startReply('tweet', ${node.id})">è¿”ä¿¡</button>
    </div>
  `;

  const frag = document.createDocumentFragment();
  frag.appendChild(div);

  node.replies.forEach(r => {
    frag.appendChild(renderTweetNode(r, depth+1));
  });

  return frag;
}

function renderDiaryCard(diary, relatedTweetRoots){
  const div = document.createElement("div");
  div.className = "card";
  const when = diary.created_at ? fmtTime(diary.created_at) : (diary.date ? `${diary.date}` : "");
  div.innerHTML = `
    <div class="meta">
      <div class="muted">ğŸ“” æ—¥è¨˜</div>
      <div class="time">${esc(when)}</div>
      <div class="muted">#${diary.id}</div>
    </div>
    <div style="margin-top:6px">${esc(diary.body || "")}</div>
    ${diary.image_url ? `<img src="${esc(diary.image_url)}" alt="image">` : ""}
    <div class="actions">
      <button class="ghost" onclick="startReply('diary', ${diary.id})">è¿”ä¿¡</button>
    </div>
  `;

  const wrap = document.createElement("div");
  wrap.appendChild(div);

  // æ—¥è¨˜ã¸ã®è¿”ä¿¡ï¼ˆreply_diary_idï¼‰ã‚’ã¶ã‚‰ä¸‹ã’ã¦è¡¨ç¤ºï¼ˆãƒ„ãƒªãƒ¼ã¯ tweets ã® parent_id å´ã§ä¿æŒï¼‰
  if(relatedTweetRoots.length){
    const sep = document.createElement("div");
    sep.className = "sep";
    wrap.appendChild(sep);

    relatedTweetRoots.forEach(root => {
      wrap.appendChild(renderTweetNode(root, 1)); // diaryé…ä¸‹ã¨ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
    });
  }

  return wrap;
}

/** ===========
 *  ãƒ­ãƒ¼ãƒ‰
 *  =========== */
async function load(){
  setError("");
  setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
  timeline.innerHTML = "";

  const m = getMonthValueOrNow();
  const { startISO, endISO, startDate, endDate } = monthRange(m);

  try{
    // 1) diaries: date(YYYY-MM-DD)ã§æœˆãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã®31å›ºå®šã‚’ä¿®æ­£ï¼‰
    //    â€»ã‚‚ã— diaries ãŒ created_at ã§ç®¡ç†ãªã‚‰ã€ä¸‹ã® where ã‚’ created_at ã«å¤‰ãˆã¦OK
    const diaries = await safeQuery(
      sb.from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .gte("date", startDate)
        .lte("date", endDate)
        .order("date", { ascending: false })
    );

    // 2) tweets: created_at ã§æœˆãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã¯æœˆã§çµã‚Œã¦ã¾ã›ã‚“ã§ã—ãŸï¼‰
    const tweets = await safeQuery(
      sb.from("tweets")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .gte("created_at", startISO)
        .lt("created_at", endISO)
        .order("created_at", { ascending: false })
    );

    // 3) ãƒ„ã‚¤ãƒ¼ãƒˆã‚’
    //    - æ—¥è¨˜ã¸ã®è¿”ä¿¡(reply_diary_id) ã¨
    //    - ãƒ„ã‚¤ãƒ¼ãƒˆè¿”ä¿¡(parent_id)
    //    ã«åˆ†ã‘ã¦ã€è¦‹ã‚„ã™ãè¡¨ç¤º
    const tweetsToDiary = (tweets || []).filter(t => t.reply_diary_id);
    const normalTweets = (tweets || []).filter(t => !t.reply_diary_id);

    const tweetRoots = buildTweetTree(normalTweets);

    // æ—¥è¨˜ã”ã¨ã«ã€æ—¥è¨˜ã¸ã®è¿”ä¿¡ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒ„ãƒªãƒ¼åŒ–ã—ã¦ã¶ã‚‰ä¸‹ã’
    const diaryReplyMap = new Map(); // diary_id -> tweet[]
    tweetsToDiary.forEach(t => {
      const k = t.reply_diary_id;
      if(!diaryReplyMap.has(k)) diaryReplyMap.set(k, []);
      diaryReplyMap.get(k).push(t);
    });

    // æ—¥è¨˜ã¸ã®è¿”ä¿¡ã‚‚ parent_id ã§ãƒ„ãƒªãƒ¼åŒ–ï¼ˆåŒã˜reply_diary_idå†…ã§ï¼‰
    function buildDiaryReplies(diaryId){
      const list = diaryReplyMap.get(diaryId) || [];
      return buildTweetTree(list); // parent_id ã§ãƒ„ãƒªãƒ¼åŒ–
    }

    // 4) çµ±åˆè¡¨ç¤ºï¼šæ—¥è¨˜ï¼‹ãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆcreated_atåŸºæº–ã§ä¸¦ã¹ã‚‹ï¼‰
    //    diariesã¯ created_at ãŒç„¡ã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ãã®å ´åˆã¯ date ã‚’ 12:00 JST ç›¸å½“ã§ä»®å¤‰æ›
    function diarySortTime(d){
      if(d.created_at) return new Date(d.created_at).getTime();
      if(d.date){
        // æ—¥ä»˜ã ã‘ã®å ´åˆã€ä¸¦ã³é †ãŒä¹±ã‚Œãªã„ã‚ˆã†ã«æ˜¼å›ºå®š
        const [y,m,da] = d.date.split("-").map(Number);
        return new Date(y, m-1, da, 12, 0, 0).getTime();
      }
      return 0;
    }

    const diaryItems = (diaries || []).map(d => ({ type:"diary", sort: diarySortTime(d), data:d }));
    const tweetItems  = (tweetRoots || []).map(t => ({ type:"tweet", sort: new Date(t.created_at).getTime(), data:t }));

    const items = [...diaryItems, ...tweetItems].sort((a,b)=>b.sort - a.sort);

    if(items.length === 0){
      timeline.innerHTML = `<div class="card"><div class="muted">ã“ã®æœˆã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
      setStatus("");
      return;
    }

    items.forEach(item => {
      if(item.type === "diary"){
        const d = item.data;
        const replyRoots = buildDiaryReplies(d.id);
        timeline.appendChild(renderDiaryCard(d, replyRoots));
      }else{
        timeline.appendChild(renderTweetNode(item.data, 0));
      }
    });

    setStatus("");
  }catch(e){
    setStatus("");
    setError(`èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${e.message || e}`);
    timeline.innerHTML = `<div class="card"><div class="muted">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div></div>`;
  }
}

/** ===========
 *  ã‚¤ãƒ™ãƒ³ãƒˆ
 *  =========== */
postBtn.addEventListener("click", post);
cancelReplyBtn.addEventListener("click", cancelReply);
reloadBtn.addEventListener("click", load);
month.addEventListener("change", load);

// Enterã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
postText.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    post();
  }
});

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆonclickã‹ã‚‰å‘¼ã¶ãŸã‚ï¼‰
window.startReply = startReply;

// åˆæœŸãƒ­ãƒ¼ãƒ‰
getMonthValueOrNow();
load();
</script>
</body>
</html>
