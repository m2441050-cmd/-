<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Couple OS</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
    max-width:1080px;margin:28px auto;padding:0 16px;
    background:linear-gradient(160deg,#f6f2ff,#ffffff);
  }
  h1{font-size:26px;margin:0 0 6px}
  h2{font-size:16px;margin:0 0 10px}
  .muted{opacity:.7;font-size:13px}
  .err{color:#b00020;font-size:13px}
  .card{
    background:#fff;border-radius:18px;padding:16px;margin:14px 0;
    box-shadow:0 12px 30px rgba(0,0,0,.06);
  }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button,textarea{
    padding:10px 12px;border-radius:10px;border:1px solid #ccc;
    font-size:14px;
  }
  button{cursor:pointer;background:#7b6cff;color:#fff;border:none}
  button.sub{background:#aaa}
  button.ghost{background:#fff;color:#333;border:1px solid #ddd}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

  /* Calendar */
  #calendarWrap{position:sticky;top:10px}
  #calendarGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .calHead{font-size:12px;opacity:.6;text-align:center}
  .calCell{
    border:1px solid #eee;border-radius:12px;padding:10px;min-height:76px;
    cursor:pointer;background:#fff;
  }
  .calCell:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .calToday{border-color:rgba(123,108,255,.7)}
  .calSelected{outline:2px solid rgba(123,108,255,.7)}
  .calNum{font-weight:700;font-size:12px}
  .calMeta{margin-top:6px;font-size:12px;opacity:.75}
  .dots{margin-top:8px;display:flex;gap:4px;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:999px;background:#7b6cff;opacity:.85}

  ul{padding-left:18px;margin:8px 0}
  li{margin:6px 0}
  .done{text-decoration:line-through;opacity:.55}
  .anniv{font-size:18px;color:#d6336c}
</style>
</head>

<body>
  <h1>ğŸ’‘ Couple OS</h1>
  <div class="muted">ã‚«ãƒƒãƒ—ãƒ«ã®ç”Ÿæ´»ã‚’ã²ã¨ã¤ã«</div>

  <!-- åˆè¨€è‘‰ï¼ˆåˆå›ã ã‘è¡¨ç¤ºï¼‰ -->
  <div class="card" id="loginCard" style="display:none">
    <h2>å…±æœ‰IDï¼ˆåˆè¨€è‘‰ï¼‰</h2>
    <div class="row">
      <input id="coupleInput" placeholder="ä¾‹ï¼škentaria" style="flex:1;min-width:220px" />
      <button id="saveCouple">ä¿å­˜</button>
    </div>
    <div class="muted">â€»ä¸€åº¦ä¿å­˜ã—ãŸã‚‰ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
    <div class="err" id="loginErr"></div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã ã‘è¡¨ç¤ºï¼‰ -->
  <div id="app" style="display:none">

    <!-- è¨˜å¿µæ—¥ï¼ˆ27æ—¥ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="card" id="annivCard" style="display:none">
      <div id="annivText" class="anniv"></div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šToDo -->
      <div>
        <div class="card">
          <h2>ToDo</h2>
          <div class="row">
            <input id="txt" placeholder="ä¾‹ï¼šæ˜æ—¥ 19æ™‚ ã‚±ãƒ¼ã‚­è²·ã† / 1/5 ç—…é™¢ã«é›»è©±" style="flex:1;min-width:240px" />
            <input id="dueDate" type="date" />
            <input id="dueTime" type="time" />
            <button id="ai">æ•´å½¢</button>
            <button id="add">è¿½åŠ </button>
          </div>
          <div class="muted" style="margin-top:8px">â€»æ—¥ä»˜ãŒç©ºãªã‚‰ã€Œä»Šæ—¥ã€ã€‚æ•´å½¢ã§æ—¥ä»˜/æ™‚é–“ã‚’æ‹¾ã„ã¾ã™ã€‚</div>
          <div class="row" style="margin-top:10px">
            <div class="muted" id="status"></div>
            <div class="err" id="error"></div>
          </div>
        </div>

        <div class="card">
          <h2 id="dayLabel">é¸æŠæ—¥ã®ToDo</h2>
          <ul id="todoList"></ul>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="muted">å¿…è¦ãªã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã¾ã™</div>
            <button id="logout" class="ghost" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
      </div>ã€€
      <!-- æ—¥è¨˜ -->
<div class="card">
  <h2>æ—¥è¨˜</h2>
  <div class="row">
    <label class="muted">æ—¥ä»˜</label>
    <input id="diaryDate" type="date" />
    <button id="loadDiary" type="button" class="ghost">è¡¨ç¤º</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="diaryTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºãªã‚‰ç„¡é¡Œï¼‰" style="flex:1;min-width:240px" />
  </div>

  <div style="margin-top:10px">
    <textarea id="diaryBody" placeholder="æœ¬æ–‡" style="width:100%;min-height:120px;resize:vertical"></textarea>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="saveDiary" type="button">ä¿å­˜</button>
    <button id="deleteDiary" type="button" class="sub">å‰Šé™¤</button>
  </div>

  <div class="row" style="margin-top:8px">
    <div class="muted" id="diaryStatus"></div>
    <div class="err" id="diaryError"></div>
  </div>

  <div class="cardSub" style="margin-top:12px">
    <h2 style="margin:0 0 6px">æœ€è¿‘ã®æ—¥è¨˜</h2>
    <ul id="diaryList"></ul>
  </div>
</div>

      <!-- å³ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div id="calendarWrap">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
            <div class="row">
              <button id="prev" type="button">â†</button>
              <button id="thisMonth" type="button">ä»Šæœˆ</button>
              <button id="next" type="button">â†’</button>
            </div>
          </div>
          <div class="row" style="justify-content:space-between;margin-top:8px">
            <div class="muted" id="monthLabel"></div>
            <div class="muted" id="selectedLabel"></div>
          </div>
          <div id="calendarGrid" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== è¨­å®š ===== */
const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ä»˜ãåˆã£ãŸæ—¥
const START_DATE = new Date("2025-08-27T00:00:00");

/* ===== DOM ===== */
const loginCard = document.getElementById("loginCard");
const app = document.getElementById("app");
const coupleInput = document.getElementById("coupleInput");
const saveCouple = document.getElementById("saveCouple");
const loginErr = document.getElementById("loginErr");

const annivCard = document.getElementById("annivCard");
const annivText = document.getElementById("annivText");

const txtEl = document.getElementById("txt");
const dueDateEl = document.getElementById("dueDate");
const dueTimeEl = document.getElementById("dueTime");
const aiBtn = document.getElementById("ai");
const addBtn = document.getElementById("add");
const statusEl = document.getElementById("status");
const errorEl = document.getElementById("error");

const monthLabelEl = document.getElementById("monthLabel");
const selectedLabelEl = document.getElementById("selectedLabel");
const calendarGridEl = document.getElementById("calendarGrid");
const dayLabelEl = document.getElementById("dayLabel");
const todoListEl = document.getElementById("todoList");

const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const thisMonthBtn = document.getElementById("thisMonth");
const logoutBtn = document.getElementById("logout");

/* ===== çŠ¶æ…‹ ===== */
let COUPLE_ID = localStorage.getItem("couple_id") || "";
let viewYear, viewMonth; // è¡¨ç¤ºä¸­ã®å¹´æœˆ
let selectedISO = "";   // é¸æŠæ—¥
let monthTodos = [];    // æœˆã®ToDo

/* ===== utils ===== */
const pad2 = (n)=> String(n).padStart(2,"0");
const toISO = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const todayISO = ()=> toISO(new Date());
const fromISO = (s)=> { const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); };

function setStatus(s){ statusEl.textContent = s || ""; }
function setError(s){ errorEl.textContent = s || ""; }

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/* ===== è¨˜å¿µæ—¥ï¼ˆ27æ—¥ã®ã¿è¡¨ç¤ºï¼‰ ===== */
function renderAnniversary(){
  const now = new Date();
  if(now.getDate() !== 27){
    annivCard.style.display="none";
    return;
  }
  const days = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - START_DATE) / 86400000);

  // å¹´/æœˆã®è¨ˆç®—ï¼ˆã€Œæ—¥ãŒè¶³ã‚Šãªã„æœˆã€ã¯ç¹°ã‚Šä¸‹ã’ï¼‰
  let years = now.getFullYear() - START_DATE.getFullYear();
  let months = now.getMonth() - START_DATE.getMonth();
  if(months < 0){ years -= 1; months += 12; }

  // 27æ—¥å›ºå®šãªã®ã§æ—¥ç¹°ã‚Šä¸‹ã’ã¯æœ¬æ¥èµ·ãã«ãã„ãŒä¿é™º
  if(now.getDate() < START_DATE.getDate()){
    months -= 1;
    if(months < 0){ months = 11; years -= 1; }
  }

  // ç¯€ç›®ï¼š500/1000/1500/2000...
  const milestones = [500,1000,1500,2000,2500,3000];
  const isMilestone = milestones.includes(days);

  annivText.textContent =
    `ğŸ‰ è¨˜å¿µæ—¥ï¼šä»˜ãåˆã£ã¦ ${years}å¹´${months}ãƒ¶æœˆï¼ˆ${days}æ—¥ï¼‰` + (isMilestone ? " ğŸŠ" : "");

  annivCard.style.display="block";
}

/* ===== ã€Œæœªå®Œäº†ã¯ç¿Œæ—¥ã«æŒã¡è¶Šã—ã€ ===== */
async function carryOverOverdue(){
  const today = todayISO();
  const { error } = await sb
    .from("todos")
    .update({ due_date: today })
    .eq("couple_id", COUPLE_ID)
    .eq("done", false)
    .lt("due_date", today);

  if(error) throw error;
}

/* ===== æœˆã®ToDoå–å¾— ===== */
async function fetchMonthTodos(y, m){
  const start = new Date(y, m, 1);
  const end = new Date(y, m+1, 0);
  const startISO = toISO(start);
  const endISO = toISO(end);

  const { data, error } = await sb
    .from("todos")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .gte("due_date", startISO)
    .lte("due_date", endISO)
    .order("due_date", { ascending:true })
    .order("created_at", { ascending:false });

  if(error) throw error;
  return data || [];
}

/* ===== AIæ•´å½¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼šæ—¥ä»˜ï¼‹æ™‚é–“ï¼‰ ===== */
function localAIParse(input){
  let s = (input || "").trim();
  const now = new Date();
  const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let due = new Date(today0);
  let time = "";

  // --- æ™‚åˆ»ï¼ˆ4æ—¥8æ™‚ ã¿ãŸã„ãªé€£çµã‚‚æ‹¾ã†ï¼‰---
  // ä¾‹: "8æ™‚", "8:30", "08:30"
  let m;
  if((m = s.match(/(\d{1,2})(?:æ™‚|:)(\d{2})?/))){
    const h = Number(m[1]);
    const mm = m[2] ? Number(m[2]) : 0;
    if(h>=0 && h<=23 && mm>=0 && mm<=59){
      time = `${String(h).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
      s = s.replace(m[0], " ").trim();
    }
  }

  // --- ç›¸å¯¾ ---
  if(/æ˜å¾Œæ—¥/.test(s)){ due.setDate(due.getDate()+2); s = s.replace("æ˜å¾Œæ—¥"," "); }
  else if(/æ˜æ—¥/.test(s)){ due.setDate(due.getDate()+1); s = s.replace("æ˜æ—¥"," "); }
  else if(/ä»Šæ—¥/.test(s)){ s = s.replace("ä»Šæ—¥"," "); }

  // --- å¹´æœˆæ—¥ ---
  if((m = s.match(/(20\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})/))){
    due = new Date(+m[1], +m[2]-1, +m[3]);
    s = s.replace(m[0]," ").trim();
  }
  // --- æœˆæ—¥ ---
  else if((m = s.match(/(\d{1,2})[\/\-](\d{1,2})/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // --- ã€Œ1æœˆ4æ—¥ã€ ---
  else if((m = s.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // --- ã€Œ4æ—¥ã€ã“ã“ãŒä»Šå›ã®è‚ ---
  else if((m = s.match(/(\d{1,2})æ—¥/))){
    const day = +m[1];
    let y = now.getFullYear();
    let mon = now.getMonth();
    let cand = new Date(y, mon, day);

    // ãã®æ—¥ãŒä»Šæ—¥ã‚ˆã‚Šå‰ãªã‚‰æ¥æœˆã¸
    if(cand < today0){
      mon += 1;
      if(mon > 11){ mon = 0; y += 1; }
      cand = new Date(y, mon, day);
    }
    due = cand;
    s = s.replace(m[0]," ").trim();
  }

  let title = s.replace(/\s+/g," ").trim();
  if(!title) title = "ToDo";
  return { title, due_date: toISO(due), due_time: time };
}

  // ---- ç›¸å¯¾æ—¥ä»˜ ----
  if(/æ˜å¾Œæ—¥/.test(s)){ due.setDate(due.getDate()+2); s = s.replace("æ˜å¾Œæ—¥"," "); }
  else if(/æ˜æ—¥/.test(s)){ due.setDate(due.getDate()+1); s = s.replace("æ˜æ—¥"," "); }
  else if(/ä»Šæ—¥/.test(s)){ s = s.replace("ä»Šæ—¥"," "); }

  // ---- YYYY/MM/DD or YYYY-MM-DD ----
  let m;
  if((m = s.match(/(20\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})/))){
    due = new Date(+m[1], +m[2]-1, +m[3]);
    s = s.replace(m[0]," ").trim();
  }
  // ---- M/D or M-D ----
  else if((m = s.match(/(\d{1,2})[\/\-](\d{1,2})/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    // éå»ãªã‚‰æ¥å¹´
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // ---- ã€Œ1æœˆ4æ—¥ã€å½¢å¼ ----
  else if((m = s.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // ---- ã€Œ4æ—¥ã€å½¢å¼ï¼ˆä»Šæœˆã®4æ—¥ã€‚éãã¦ãŸã‚‰æ¥æœˆã®4æ—¥ï¼‰ ----
  else if((m = s.match(/(\d{1,2})æ—¥/))){
    const day = +m[1];
    let y = now.getFullYear();
    let mon = now.getMonth();
    let cand = new Date(y, mon, day);
    if(cand < today0){
      mon += 1;
      if(mon > 11){ mon = 0; y += 1; }
      cand = new Date(y, mon, day);
    }
    due = cand;
    s = s.replace(m[0]," ").trim();
  }

  // ---- ã‚¿ã‚¤ãƒˆãƒ«æ•´å½¢ ----
  let title = s.replace(/\s+/g," ").trim();
  if(!title) title = "ToDo";

  return { title, due_date: toISO(due), due_time: time };
}

  // ä»Šæ—¥/æ˜æ—¥/æ˜å¾Œæ—¥
  if(/æ˜å¾Œæ—¥/.test(s)){ due.setDate(due.getDate()+2); s = s.replace("æ˜å¾Œæ—¥"," "); }
  else if(/æ˜æ—¥/.test(s)){ due.setDate(due.getDate()+1); s = s.replace("æ˜æ—¥"," "); }
  else if(/ä»Šæ—¥/.test(s)){ s = s.replace("ä»Šæ—¥"," "); }

  // YYYY/MM/DD or YYYY-MM-DD
  const ymd = s.match(/(20\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if(ymd){
    due = new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
    s = s.replace(ymd[0]," ").trim();
  } else {
    // M/D or M-Dï¼ˆéå»ãªã‚‰æ¥å¹´ï¼‰
    const md = s.match(/(\d{1,2})[\/\-](\d{1,2})/);
    if(md){
      const m = +md[1], d = +md[2];
      let y = now.getFullYear();
      let cand = new Date(y, m-1, d);
      const today = new Date(now.getFullYear(),now.getMonth(),now.getDate());
      if(cand < today) cand = new Date(y+1, m-1, d);
      due = cand;
      s = s.replace(md[0]," ").trim();
    }
  }

  // ã‚¿ã‚¤ãƒˆãƒ«æ•´å½¢
  let title = s.replace(/\s+/g," ").trim();
  if(!title) title = "ToDo";

  return { title, due_date: toISO(due), due_time: time };
}

/* ===== UIæç”» ===== */
function groupByDate(todos){
  const map = new Map();
  for(const t of todos){
    if(!map.has(t.due_date)) map.set(t.due_date, []);
    map.get(t.due_date).push(t);
  }
  return map;
}

function buildCalendar(){
  calendarGridEl.innerHTML = "";

  // ãƒ˜ãƒƒãƒ€
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(h=>{
    const el = document.createElement("div");
    el.className="calHead";
    el.textContent=h;
    calendarGridEl.appendChild(el);
  });

  monthLabelEl.textContent = `${viewYear}å¹´ ${viewMonth+1}æœˆ`;
  selectedLabelEl.textContent = `é¸æŠï¼š${selectedISO}`;

  const first = new Date(viewYear, viewMonth, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
  const byDate = groupByDate(monthTodos);
  const tISO = todayISO();

  // ç©ºç™½
  for(let i=0;i<startDow;i++){
    calendarGridEl.appendChild(document.createElement("div"));
  }

  for(let day=1; day<=daysInMonth; day++){
    const iso = `${viewYear}-${pad2(viewMonth+1)}-${pad2(day)}`;
    const cell = document.createElement("div");
    cell.className = "calCell";
    if(iso === tISO) cell.classList.add("calToday");
    if(iso === selectedISO) cell.classList.add("calSelected");

    const num = document.createElement("div");
    num.className="calNum";
    num.textContent = day;

    const items = (byDate.get(iso) || []).filter(x=>!x.done);
    const meta = document.createElement("div");
    meta.className="calMeta";
    meta.textContent = items.length ? `æœªå®Œäº† ${items.length}ä»¶` : " ";

    const dots = document.createElement("div");
    dots.className="dots";
    items.slice(0,6).forEach(()=> {
      const d = document.createElement("span");
      d.className="dot";
      dots.appendChild(d);
    });

    cell.appendChild(num);
    cell.appendChild(meta);
    cell.appendChild(dots);

    cell.addEventListener("click", ()=>{
      selectedISO = iso;
      dueDateEl.value = iso;
      renderDayList();
      buildCalendar();
    });

    calendarGridEl.appendChild(cell);
  }
}

function renderDayList(){
  dayLabelEl.textContent = `${selectedISO} ã®ToDo`;
  todoListEl.innerHTML = "";

  const items = monthTodos.filter(t => t.due_date === selectedISO);
  if(items.length === 0){
    const li = document.createElement("li");
    li.className="muted";
    li.textContent="ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“";
    todoListEl.appendChild(li);
    return;
  }

  items.forEach(t=>{
    const li = document.createElement("li");
    li.className = t.done ? "done" : "";

    const time = (t.due_time || "").trim();
    const timeLabel = time ? `ï¼ˆ${time}ï¼‰` : "";

    li.innerHTML = `
      <label style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" ${t.done ? "checked":""} />
        <span style="flex:1">${escapeHtml(t.title)} <span class="muted">${escapeHtml(timeLabel)}</span></span>
        <button type="button" class="sub">å‰Šé™¤</button>
      </label>
    `;

    li.querySelector("input").addEventListener("change", async (e)=>{
      setError("");
      const { error } = await sb.from("todos").update({ done: e.target.checked }).eq("id", t.id);
      if(error){ setError(error.message); return; }
      await reloadMonth();
    });

    li.querySelector("button").addEventListener("click", async ()=>{
      setError("");
      const { error } = await sb.from("todos").delete().eq("id", t.id);
      if(error){ setError(error.message); return; }
      await reloadMonth();
    });

    todoListEl.appendChild(li);
  });
}

/* ===== ãƒ¡ã‚¤ãƒ³åŒæœŸ ===== */
async function reloadMonth(){
  setError("");
  try{
    setStatus("åŒæœŸä¸­â€¦");
    await carryOverOverdue();

    monthTodos = await fetchMonthTodos(viewYear, viewMonth);

    setStatus("OK");
    buildCalendar();
    renderDayList();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
aiBtn.addEventListener("click", ()=>{
  const raw = (txtEl.value || "").trim();
  if(!raw) return;
  const p = localAIParse(raw);
  txtEl.value = p.title;
  dueDateEl.value = p.due_date;
  dueTimeEl.value = p.due_time;
  selectedISO = p.due_date;
  // è¡¨ç¤ºæœˆã‚‚åˆã‚ã›ã‚‹
  const d = fromISO(p.due_date);
  viewYear = d.getFullYear();
  viewMonth = d.getMonth();
  reloadMonth();
});

addBtn.addEventListener("click", async ()=>{
  const raw = (txtEl.value || "").trim();
  if(!raw){ setError("ToDoãŒç©ºã§ã™"); return; }

  // å…¥åŠ›æ¬„ã®æ—¥ä»˜/æ™‚é–“
  let due = dueDateEl.value || "";
  let time = dueTimeEl.value || "";

  // â˜… ã“ã“ã§å¿…ãšAIè§£æï¼ˆæ•´å½¢æŠ¼ã—å¿˜ã‚Œå¯¾ç­–ï¼‰
  const p = localAIParse(raw);

  // æ—¥ä»˜æ¬„ãŒç©ºãªã‚‰AIã®çµæœã‚’æ¡ç”¨
  if(!due) due = p.due_date;
  // æ™‚åˆ»æ¬„ãŒç©ºãªã‚‰AIã®çµæœã‚’æ¡ç”¨
  if(!time) time = p.due_time;

  // ã‚¿ã‚¤ãƒˆãƒ«ã¯AIæ•´å½¢ã®ã‚‚ã®ã‚’åŸºæœ¬æ¡ç”¨ï¼ˆä½™è¨ˆãªæ—¥ä»˜/æ™‚åˆ»ãŒæ®‹ã‚‰ãªã„ï¼‰
  const title = p.title;

  setError("");
  try{
    setStatus("è¿½åŠ ä¸­â€¦");
    const { error } = await sb.from("todos").insert([{
      couple_id: COUPLE_ID,
      title,
      due_date: due,
      due_time: time || null,
      done: false
    }]);
    if(error) throw error;

    // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
    txtEl.value = "";
    dueTimeEl.value = "";
    // é¸æŠæ—¥ã‚’è¿½åŠ ã—ãŸæ—¥ã«åˆã‚ã›ã‚‹
    selectedISO = due;
    dueDateEl.value = due;

    const d = fromISO(due);
    viewYear = d.getFullYear();
    viewMonth = d.getMonth();

    await reloadMonth();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
});

prevBtn.addEventListener("click", async ()=>{
  viewMonth -= 1;
  if(viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
  selectedISO = `${viewYear}-${pad2(viewMonth+1)}-01`;
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

nextBtn.addEventListener("click", async ()=>{
  viewMonth += 1;
  if(viewMonth > 11){ viewMonth = 0; viewYear += 1; }
  selectedISO = `${viewYear}-${pad2(viewMonth+1)}-01`;
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

// ä»Šæœˆï¼šä»Šæœˆè¡¨ç¤ºï¼‹ã€Œä»Šæ—¥ã€ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
thisMonthBtn.addEventListener("click", async ()=>{
  const t = new Date();
  viewYear = t.getFullYear();
  viewMonth = t.getMonth();
  selectedISO = todayISO();         // â† ä»Šæ—¥ã¸
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

logoutBtn.addEventListener("click", ()=>{
  localStorage.removeItem("couple_id");
  location.reload();
});

/* ===== åˆæœŸåŒ– ====/* ===== æ—¥è¨˜ ===== */
const diaryDateEl = document.getElementById("diaryDate");
const diaryTitleEl = document.getElementById("diaryTitle");
const diaryBodyEl = document.getElementById("diaryBody");
const loadDiaryBtn = document.getElementById("loadDiary");
const saveDiaryBtn = document.getElementById("saveDiary");
const deleteDiaryBtn = document.getElementById("deleteDiary");
const diaryStatusEl = document.getElementById("diaryStatus");
const diaryErrorEl = document.getElementById("diaryError");
const diaryListEl = document.getElementById("diaryList");

let currentDiaryId = null;

function setDiaryStatus(s){ diaryStatusEl.textContent = s || ""; }
function setDiaryError(s){ diaryErrorEl.textContent = s || ""; }

async function fetchDiary(dateISO){
  const { data, error } = await sb
    .from("diaries")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .eq("date", dateISO)
    .order("created_at", { ascending:false })
    .limit(1);

  if(error) throw error;
  return (data && data[0]) || null;
}

async function insertDiary(dateISO, title, body){
  const { error } = await sb
    .from("diaries")
    .insert([{ couple_id: COUPLE_ID, date: dateISO, title, body }]);
  if(error) throw error;
}

async function deleteDiaryById(id){
  const { error } = await sb.from("diaries").delete().eq("id", id);
  if(error) throw error;
}

async function listRecentDiaries(){
  const { data, error } = await sb
    .from("diaries")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .order("created_at", { ascending:false })
    .limit(7);
  if(error) throw error;
  return data || [];
}

async function renderDiaryList(){
  diaryListEl.innerHTML = "";
  const items = await listRecentDiaries();
  items.forEach(it=>{
    const li = document.createElement("li");
    li.style.cursor = "pointer";
    li.innerHTML = `<b>${it.date}</b>ï¼š${escapeHtml(it.title || "ç„¡é¡Œ")} <span class="muted">(${new Date(it.created_at).toLocaleString()})</span>`;
    li.addEventListener("click", ()=>{
      diaryDateEl.value = it.date;
      loadDiary();
    });
    diaryListEl.appendChild(li);
  });
}

async function loadDiary(){
  const dateISO = diaryDateEl.value || todayISO();
  diaryDateEl.value = dateISO;

  try{
    setDiaryError(""); setDiaryStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const d = await fetchDiary(dateISO);
    if(!d){
      currentDiaryId = null;
      diaryTitleEl.value = "";
      diaryBodyEl.value = "";
      setDiaryStatus("ã“ã®æ—¥ã®æ—¥è¨˜ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
    }else{
      currentDiaryId = d.id;
      diaryTitleEl.value = d.title || "";
      diaryBodyEl.value = d.body || "";
      setDiaryStatus("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    }
    await renderDiaryList();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("æ—¥è¨˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

async function saveDiary(){
  const dateISO = diaryDateEl.value || todayISO();
  diaryDateEl.value = dateISO;

  const title = (diaryTitleEl.value || "").trim() || "ç„¡é¡Œ";
  const body = (diaryBodyEl.value || "").trim();
  if(!body){ setDiaryError("æœ¬æ–‡ãŒç©ºã§ã™"); return; }

  try{
    setDiaryError(""); setDiaryStatus("ä¿å­˜ä¸­â€¦");
    await insertDiary(dateISO, title, body);
    setDiaryStatus("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    await loadDiary();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

async function deleteDiary(){
  if(!currentDiaryId){ setDiaryError("å‰Šé™¤ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  try{
    setDiaryError(""); setDiaryStatus("å‰Šé™¤ä¸­â€¦");
    await deleteDiaryById(currentDiaryId);
    currentDiaryId = null;
    diaryTitleEl.value = "";
    diaryBodyEl.value = "";
    setDiaryStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    await renderDiaryList();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

loadDiaryBtn.addEventListener("click", loadDiary);
saveDiaryBtn.addEventListener("click", saveDiary);
deleteDiaryBtn.addEventListener("click", deleteDiary);
 */
  
(function init(){
  if(!COUPLE_ID){
    loginCard.style.display="block";
    app.style.display="none";
    saveCouple.addEventListener("click", ()=>{
      const v = (coupleInput.value || "").trim();
      if(!v){ loginErr.textContent = "åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      localStorage.setItem("couple_id", v);
      location.reload();
    });
    return;
  }

  loginCard.style.display="none";
  app.style.display="block";
  diaryDateEl.value = todayISO();
renderDiaryList();

  renderAnniversary();

  const t = new Date();
  viewYear = t.getFullYear();
  viewMonth = t.getMonth();
  selectedISO = todayISO();
  dueDateEl.value = selectedISO;

  reloadMonth();
})();
</script>
</body>
</html>
