<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ—¥è¨˜ã‚’è¦‹è¿”ã™ - Couple OS</title>

  <!-- Supabaseï¼ˆå…ˆã«èª­ã¿è¾¼ã¾ã›ã‚‹ï¼‰ -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
      max-width:1100px;margin:28px auto;padding:0 16px;
      background:linear-gradient(160deg,#f6f2ff,#ffffff);
      min-height:100vh;
    }
    h1{font-size:22px;margin:0 0 8px}
    h2{font-size:16px;margin:0 0 8px}
    .muted{opacity:.75;font-size:13px}
    .err{color:#b00020;font-size:13px;white-space:pre-wrap}
    .ok{color:#0b7a35;font-size:13px;white-space:pre-wrap}
    .card{
      background:#fff;border-radius:18px;padding:16px;margin:14px 0;
      box-shadow:0 12px 30px rgba(0,0,0,.06);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button,textarea,select{
      padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:14px;
    }
    button{cursor:pointer;background:#7b6cff;color:#fff;border:none}
    button.ghost{background:#fff;color:#333;border:1px solid #ddd}
    button.sub{background:#aaa}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:980px){ .grid{grid-template-columns:420px 1fr} }
    ul{padding-left:18px;margin:8px 0}
    li{margin:8px 0}
    li a{cursor:pointer;text-decoration:none;color:#333}
    li a:hover{text-decoration:underline}
    .itemDate{font-weight:700}
    .preview{white-space:pre-wrap;line-height:1.6}

    /* å¹´é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    #yearCalendar{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    @media(min-width:980px){
      #yearCalendar{ grid-template-columns:repeat(6,1fr); }
    }
    .monthBox{
      border:1px solid #eee;border-radius:14px;padding:10px;background:#fafafa;
      min-height:90px;
    }
    .dotsRow{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .dayDot{
      width:28px;height:28px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;
      background:#7b6cff;color:#fff;
      cursor:pointer;
    }

    /* ç”»é¢ä¸Šéƒ¨ã®ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ï¼ˆçœŸã£ç™½å›é¿ï¼‰ */
    #fatalBanner{
      display:none;
      position:sticky; top:0; z-index:9999;
      background:#fff3f3; border:1px solid #ffd0d0;
      padding:10px 12px; border-radius:12px; margin:10px 0;
    }
  </style>
</head>

<body>
  <div id="fatalBanner">
    <div class="err" id="fatalText"></div>
    <div class="muted" style="margin-top:6px">
      â€»ã“ã®èµ¤ã„è¡¨ç¤ºãŒå‡ºãŸã‚‰ã€ãƒšãƒ¼ã‚¸ã¯â€œçœŸã£ç™½â€ã«ãªã‚‰ãšã«åŸå› ãŒè¦‹ãˆã¾ã™ã€‚
    </div>
  </div>

  <div class="row" style="justify-content:space-between">
    <div>
      <h1>ğŸ“” æ—¥è¨˜ã‚’è¦‹è¿”ã™</h1>
      <div class="muted">æœˆã§çµã‚Šè¾¼ã¿ï¼†æ¤œç´¢ã§ãã¾ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ä¸Šã«èµ¤ãå‡ºã¾ã™ï¼‰</div>
    </div>
    <div class="row">
      <button class="ghost" type="button" onclick="location.href='./index.html'">â† æˆ»ã‚‹</button>
      <button class="ghost" type="button" id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆdiaryå˜ä½“ã§å…¥ã‚Œã‚‹ï¼‰ -->
  <div class="card" id="loginCard" style="display:none">
    <h2>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆè¨€è‘‰ï¼‰</h2>
    <div class="muted">ã‚ãªãŸé”2äººã ã‘ã§ä½¿ã†å‰æã€‚åˆè¨€è‘‰ã¯å›ºå®šã§OKã€‚</div>
    <div class="row" style="margin-top:10px">
      <input id="pw" type="password" placeholder="åˆè¨€è‘‰" style="min-width:220px" />
      <button id="loginBtn" type="button">å…¥ã‚‹</button>
      <button id="autoBtn" class="ghost" type="button">è‡ªå‹•ã§å…¥ã‚‹ï¼ˆkentariaï¼‰</button>
    </div>
    <div class="err" id="loginErr" style="margin-top:8px"></div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <div id="app" style="display:none">
    <!-- æ¤œç´¢ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <div class="row">
        <label class="muted">æœˆ</label>
        <input id="month" type="month" />
        <label class="muted">æ¤œç´¢</label>
        <input id="q" type="text" placeholder="ä¾‹ï¼šæ—…è¡Œ / ã—ã‚“ã©ã„ / ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ" style="flex:1;min-width:220px" />
        <button id="searchBtn" type="button">æ¤œç´¢</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="muted" id="status"></div>
        <div class="err" id="error"></div>
        <div class="ok" id="ok"></div>
      </div>
    </div>

    <!-- å¹´é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="card">
      <h2>ğŸ“† å¹´é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ—¥è¨˜ãŒã‚ã‚‹æ—¥ã«â—ï¼‰</h2>
      <div id="yearCalendar"></div>
      <div class="muted" style="margin-top:8px">â— ã‚’æŠ¼ã™ã¨ã€ãã®æœˆã«åˆ‡ã‚Šæ›¿ã‚ã£ã¦ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™</div>
    </div>

    <div class="grid">
      <div class="card">
        <h1 style="font-size:16px;margin:0 0 8px">ä¸€è¦§</h1>
        <ul id="list"></ul>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h1 style="font-size:16px;margin:0">è¡¨ç¤º</h1>
          <button class="sub" id="deleteBtn" type="button" style="display:none">ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤</button>
        </div>
        <div class="muted" id="detailMeta"></div>
        <h2 id="detailTitle" style="margin:10px 0 0"></h2>
        <div id="detailBody" class="preview" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªJSï¼ˆSupabaseèª­ã¿è¾¼ã¿å¾Œã«å‹•ãï¼‰ -->
  <script defer>
  (function(){
    // ===== è¨­å®š =====
    const FIXED_COUPLE_ID = "kentaria"; // å›ºå®šé‹ç”¨
    const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";

    // ===== ä¾¿åˆ©ï¼šè‡´å‘½ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«å‡ºã™ =====
    const fatalBanner = document.getElementById("fatalBanner");
    const fatalText = document.getElementById("fatalText");
    function showFatal(err){
      fatalBanner.style.display = "block";
      fatalText.textContent =
        "ãƒšãƒ¼ã‚¸ãŒæ­¢ã¾ã‚Šã¾ã—ãŸï¼ˆåŸå› ï¼‰:\n" +
        (err && (err.stack || err.message) ? (err.stack || err.message) : String(err));
    }

    // DOMContentLoadedã§ç¢ºå®Ÿã«DOMã‚’æ´ã‚€
    window.addEventListener("DOMContentLoaded", async ()=>{
      try{
        // SupabaseãŒã¾ã ç„¡ã„å ´åˆã¯å¾…ã¤ï¼ˆçœŸã£ç™½é˜²æ­¢ï¼‰
        if(!window.supabase || !window.supabase.createClient){
          throw new Error("Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼ˆCDNãƒ–ãƒ­ãƒƒã‚¯/é€šä¿¡/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã€‚");
        }

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== DOM =====
        const app = document.getElementById("app");
        const loginCard = document.getElementById("loginCard");
        const pw = document.getElementById("pw");
        const loginBtn = document.getElementById("loginBtn");
        const autoBtn = document.getElementById("autoBtn");
        const loginErr = document.getElementById("loginErr");

        const monthEl = document.getElementById("month");
        const qEl = document.getElementById("q");
        const searchBtn = document.getElementById("searchBtn");
        const listEl = document.getElementById("list");
        const statusEl = document.getElementById("status");
        const errorEl = document.getElementById("error");
        const okEl = document.getElementById("ok");
        const yearCalendarEl = document.getElementById("yearCalendar");

        const detailMeta = document.getElementById("detailMeta");
        const detailTitle = document.getElementById("detailTitle");
        const detailBody = document.getElementById("detailBody");
        const deleteBtn = document.getElementById("deleteBtn");
        const logoutBtn = document.getElementById("logout");

        let currentDiaryId = null;
        let COUPLE_ID = localStorage.getItem("couple_id") || "";

        function setStatus(s){ statusEl.textContent = s || ""; }
        function setError(s){ errorEl.textContent = s || ""; }
        function setOk(s){ okEl.textContent = s || ""; }
        function escapeHtml(s){
          return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
        }
        function highlight(text, q){
          if(!q) return text || "";
          const esc = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          return (text||"").replace(new RegExp(esc,"gi"), m => `ã€${m}ã€‘`);
        }
        function todayMonthISO(){
          const d = new Date();
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        }
        function monthRange(monthISO){
          const [y,m] = monthISO.split("-").map(Number);
          const start = new Date(y, m-1, 1);
          const end = new Date(y, m, 0);
          const toISO = (dt)=> `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
          return { start: toISO(start), end: toISO(end) };
        }

        async function loadBackground(){
          try{
            const { data, error } = await sb
              .from("couple_settings")
              .select("*")
              .eq("couple_id", COUPLE_ID)
              .maybeSingle();
            if(error) return;
            if(data && data.background_url){
              document.body.style.background = `url(${data.background_url}) center/cover fixed`;
            }
          }catch(_){}
        }

        async function loadList(){
          setError(""); setOk("");
          try{
            setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
            const { start, end } = monthRange(monthEl.value || todayMonthISO());
            const query = (qEl.value || "").trim().toLowerCase();

            const { data, error } = await sb
              .from("diaries")
              .select("*")
              .eq("couple_id", COUPLE_ID)
              .gte("date", start)
              .lte("date", end)
              .order("date", { ascending:false })
              .order("created_at", { ascending:false })
              .limit(200);

            if(error) throw error;

            const filtered = (data || []).filter(d=>{
              if(!query) return true;
              return (d.title||"").toLowerCase().includes(query) || (d.body||"").toLowerCase().includes(query);
            });

            listEl.innerHTML = "";
            if(filtered.length === 0){
              const li = document.createElement("li");
              li.className="muted";
              li.textContent="ã“ã®æœˆã®æ—¥è¨˜ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯æ¤œç´¢ã«ãƒ’ãƒƒãƒˆãªã—ï¼‰";
              listEl.appendChild(li);
              detailMeta.textContent="";
              detailTitle.textContent="";
              detailBody.textContent="";
              deleteBtn.style.display="none";
              currentDiaryId = null;
            }else{
              filtered.forEach(d=>{
                const li = document.createElement("li");
                const titleH = highlight(d.title || "ç„¡é¡Œ", query);
                const bodyH = highlight((d.body || "").replace(/\s+/g," ").slice(0,40), query);

                li.innerHTML = `
                  <a>
                    <span class="itemDate">${escapeHtml(d.date)}</span>
                    ï¼š${escapeHtml(titleH)}
                    <div class="muted">${escapeHtml(bodyH)}${(d.body||"").length>40?"â€¦":""}</div>
                  </a>
                `;
                li.querySelector("a").addEventListener("click", ()=> showDiary(d));
                listEl.appendChild(li);
              });
              showDiary(filtered[0]);
            }

            setStatus(`OKï¼ˆ${filtered.length}ä»¶ï¼‰`);
          }catch(err){
            setStatus("");
            setError(err.message || String(err));
          }
        }

        function showDiary(d){
          currentDiaryId = d.id;
          deleteBtn.style.display = "inline-block";
          detailMeta.textContent = `${d.date} / ${new Date(d.created_at).toLocaleString()}`;
          detailTitle.textContent = d.title || "ç„¡é¡Œ";
          detailBody.textContent = d.body || "";
        }

        async function deleteCurrent(){
          if(!currentDiaryId) return;
          if(!confirm("ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

          setError(""); setOk("");
          try{
            setStatus("å‰Šé™¤ä¸­â€¦");
            const { error } = await sb.from("diaries").delete().eq("id", currentDiaryId);
            if(error) throw error;

            currentDiaryId = null;
            deleteBtn.style.display="none";
            detailMeta.textContent="";
            detailTitle.textContent="";
            detailBody.textContent="";

            await loadList();
            await renderYearCalendar();
            setOk("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
          }catch(err){
            setStatus("");
            setError(err.message || String(err));
          }
        }

        async function renderYearCalendar(){
          const year = new Date().getFullYear();
          const { data, error } = await sb
            .from("diaries")
            .select("date")
            .eq("couple_id", COUPLE_ID)
            .gte("date", `${year}-01-01`)
            .lte("date", `${year}-12-31`);

          if(error) return;

          const byMonth = Array.from({length:12}, ()=>[]);
          (data||[]).forEach(r=>{
            const [y,m,d] = r.date.split("-").map(Number);
            if(y !== year) return;
            byMonth[m-1].push(d);
          });

          yearCalendarEl.innerHTML = "";
          for(let m=0;m<12;m++){
            const box = document.createElement("div");
            box.className = "monthBox";

            const title = document.createElement("div");
            title.innerHTML = `<b>${m+1}æœˆ</b>`;
            box.appendChild(title);

            const days = Array.from(new Set(byMonth[m])).sort((a,b)=>a-b);
            const row = document.createElement("div");
            row.className = "dotsRow";

            days.forEach(day=>{
              const dot = document.createElement("div");
              dot.className = "dayDot";
              dot.textContent = day;
              dot.onclick = ()=>{
                monthEl.value = `${year}-${String(m+1).padStart(2,"0")}`;
                loadList();
              };
              row.appendChild(dot);
            });

            box.appendChild(row);
            yearCalendarEl.appendChild(box);
          }
        }

        function showLogin(){
          app.style.display = "none";
          loginCard.style.display = "block";
          loginErr.textContent = "";
        }
        async function enterApp(){
          loginCard.style.display = "none";
          app.style.display = "block";

          monthEl.value = todayMonthISO();
          await loadBackground();
          await loadList();
          await renderYearCalendar();
        }

        // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
        searchBtn.addEventListener("click", loadList);
        monthEl.addEventListener("change", loadList);
        qEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadList(); });
        deleteBtn.addEventListener("click", deleteCurrent);

        logoutBtn.addEventListener("click", ()=>{
          localStorage.removeItem("couple_id");
          location.reload();
        });

        loginBtn.addEventListener("click", async ()=>{
          const v = (pw.value || "").trim();
          // å›ºå®šé‹ç”¨ï¼šåˆè¨€è‘‰ãŒä¸€è‡´ã—ãŸã‚‰OK
          if(v !== FIXED_COUPLE_ID){
            loginErr.textContent = "åˆè¨€è‘‰ãŒé•ã„ã¾ã™ï¼ˆæ­£ï¼škentariaï¼‰";
            return;
          }
          COUPLE_ID = FIXED_COUPLE_ID;
          localStorage.setItem("couple_id", COUPLE_ID);
          await enterApp();
        });

        autoBtn.addEventListener("click", async ()=>{
          COUPLE_ID = FIXED_COUPLE_ID;
          localStorage.setItem("couple_id", COUPLE_ID);
          await enterApp();
        });

        // ===== èµ·å‹• =====
        // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰å…¥ã‚‹ã€‚ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã€‚
        if(!COUPLE_ID){
          showLogin();
        }else{
          await enterApp();
        }

      }catch(err){
        showFatal(err);
      }
    });
  })();
  </script>
</body>
</html>
