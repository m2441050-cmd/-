<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Couple Timeline</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;max-width:900px;margin:auto;padding:12px;background:#f6f2ff}
.card{background:#fff;border-radius:14px;padding:12px;margin:10px 0}
textarea,input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc}
button{padding:6px 12px;border-radius:999px;border:none;background:#7b6cff;color:#fff}
.muted{font-size:12px;opacity:.7}
.reply{margin-left:16px;border-left:3px solid #eee;padding-left:8px}
</style>
</head>

<body>
<h2>ğŸ•Šï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>

<div class="card">
  <textarea id="tweetText" placeholder="ã¤ã¶ã‚„ãâ€¦"></textarea>
  <button onclick="postTweet()">æŠ•ç¨¿</button>
</div>

<div class="card">
  <label class="muted">æœˆã§çµã‚Šè¾¼ã¿</label>
  <input type="month" id="month">
</div>

<div id="timeline"></div>

<script>
const sb = supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);
const COUPLE_ID = "kentaria";

function esc(s){return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

async function postTweet(parent_id=null){
  const body = tweetText.value.trim();
  if(!body) return;
  await sb.from("tweets").insert([{ couple_id:COUPLE_ID, body, parent_id }]);
  tweetText.value="";
  load();
}

async function toggleLike(type,id){
  const { data } = await sb.from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .eq("target_type",type)
    .eq("target_id",id)
    .maybeSingle();

  if(data){
    await sb.from("likes").delete().eq("id",data.id);
  }else{
    await sb.from("likes").insert([{ couple_id:COUPLE_ID, target_type:type, target_id:id }]);
  }
  load();
}

function monthRange(m){
  if(!m){const d=new Date();m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;}
  const [y,mm]=m.split("-");
  return {start:`${y}-${mm}-01`, end:`${y}-${mm}-31`};
}

async function load(){
  timeline.innerHTML="èª­ã¿è¾¼ã¿ä¸­â€¦";
  const {start,end}=monthRange(month.value);

  const { data: diaries } = await sb.from("diaries")
    .select("*").eq("couple_id",COUPLE_ID)
    .gte("date",start).lte("date",end);

  const { data: tweets } = await sb.from("tweets")
    .select("*").eq("couple_id",COUPLE_ID);

  const { data: likes } = await sb.from("likes")
    .select("*").eq("couple_id",COUPLE_ID);

  const likeMap={};
  (likes||[]).forEach(l=>likeMap[l.target_type+"_"+l.target_id]=(likeMap[l.target_type+"_"+l.target_id]||0)+1);

  const items=[
    ...(diaries||[]).map(d=>({...d,type:"diary",created_at:d.created_at})),
    ...(tweets||[]).map(t=>({...t,type:"tweet"}))
  ].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  timeline.innerHTML="";
  items.forEach(it=>{
    const key=it.type+"_"+it.id;
    const div=document.createElement("div");
    div.className="card"+(it.parent_id?" reply":"");
    div.innerHTML=`
      <div class="muted">${it.type==="diary"?"ğŸ“” æ—¥è¨˜":"ğŸ•Šï¸ ã¤ã¶ã‚„ã"}</div>
      <div>${esc(it.title||"")}</div>
      <div>${esc(it.body||"")}</div>
      <button onclick="toggleLike('${it.type}',${it.id})">â™¥ ${likeMap[key]||0}</button>
      ${it.type==="tweet"?`<button onclick="tweetText.value='â†© ';postTweet(${it.id})">è¿”ä¿¡</button>`:""}
    `;
    timeline.appendChild(div);
  });
}

month.onchange=load;
load();
</script>
</body>
</html>
