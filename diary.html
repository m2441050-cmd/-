<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Timeline - Couple OS</title>

<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  max-width:900px;margin:0 auto;padding:12px;
  background:#f6f2ff;
}
h1{font-size:20px;margin:0}
.muted{opacity:.7;font-size:13px}
.err{color:#b00020;font-size:13px}
.ok{color:#0b7a35;font-size:13px}

.card{
  background:#fff;border-radius:16px;padding:14px;margin:12px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
textarea,input{
  width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;
}
button{
  padding:8px 14px;border-radius:999px;
  border:none;background:#7b6cff;color:#fff;
}
button.ghost{background:#fff;color:#333;border:1px solid #ddd}
img{max-width:100%;border-radius:12px;margin-top:8px}

.post{border-bottom:1px solid #eee;padding-bottom:12px;margin-bottom:12px}
.actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.reply{margin-left:16px;border-left:3px solid #eee;padding-left:10px}
.small{font-size:12px}
</style>
</head>

<body>

<h1>üïäÔ∏è „Çø„Ç§„É†„É©„Ç§„É≥</h1>
<div class="muted">Êó•Ë®ò„Éª„Å§„Å∂„ÇÑ„Åç„ÉªÂÜôÁúü„Éª„ÅÑ„ÅÑ„Å≠„ÉªËøî‰ø°</div>

<div class="card">
  <textarea id="tweetBody" placeholder="„ÅÑ„Åæ„ÅÆÊ∞óÊåÅ„Å°„Çí‰∏ÄË®Ä‚Ä¶ÔºàÊó•Ë®ò„Å®„ÅØÂà•Ôºâ"></textarea>
  <input type="file" id="tweetImage" accept="image/*">
  <div style="margin-top:8px">
    <button id="tweetBtn">ÊäïÁ®ø</button>
  </div>
  <div class="err" id="err"></div>
  <div class="ok" id="ok"></div>
</div>

<div id="timeline"></div>

<script>
const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
const COUPLE_ID = "kentaria";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const timeline = document.getElementById("timeline");
const errEl = document.getElementById("err");
const okEl = document.getElementById("ok");

function esc(s){return (s||"").replace(/[&<>"']/g,c=>(
{"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]
));}

async function uploadImage(file){
  if(!file) return null;
  const path = `${COUPLE_ID}/${Date.now()}_${file.name}`;
  const { error } = await sb.storage.from("timeline-images").upload(path, file, { upsert:true });
  if(error) throw error;
  return sb.storage.from("timeline-images").getPublicUrl(path).data.publicUrl;
}

async function postTweet(parent_id=null){
  errEl.textContent=""; okEl.textContent="";
  try{
    const body = tweetBody.value.trim();
    if(!body){ errEl.textContent="Á©∫„Åß„Åô"; return; }

    const image = await uploadImage(tweetImage.files[0]);

    await sb.from("tweets").insert([{
      couple_id: COUPLE_ID,
      body,
      image_url: image,
      parent_id
    }]);

    tweetBody.value="";
    tweetImage.value="";
    okEl.textContent="ÊäïÁ®ø„Åó„Åæ„Åó„Åü";
    loadTimeline();
  }catch(e){
    errEl.textContent=e.message;
  }
}

tweetBtn.onclick = ()=>postTweet();

async function toggleLike(type,id){
  const { data } = await sb.from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .eq("target_type",type)
    .eq("target_id",id)
    .maybeSingle();

  if(data){
    await sb.from("likes").delete().eq("id",data.id);
  }else{
    await sb.from("likes").insert([{
      couple_id:COUPLE_ID,
      target_type:type,
      target_id:id
    }]);
  }
  loadTimeline();
}

async function loadTimeline(){
  timeline.innerHTML="Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";

  const { data: tweets } = await sb
    .from("tweets")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .order("created_at",{ascending:false});

  const { data: likes } = await sb
    .from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID);

  const likeMap = {};
  likes.forEach(l=>{
    const k = l.target_type+"_"+l.target_id;
    likeMap[k]=(likeMap[k]||0)+1;
  });

  timeline.innerHTML="";
  tweets.filter(t=>!t.parent_id).forEach(t=>{
    renderPost(t,tweets,likeMap);
  });
}

function renderPost(t,all,likeMap,depth=0){
  const div=document.createElement("div");
  div.className="post"+(depth?" reply":"");
  const key="tweet_"+t.id;
  div.innerHTML=`
    <div>${esc(t.body)}</div>
    ${t.image_url?`<img src="${esc(t.image_url)}">`:""}
    <div class="actions small">
      <button onclick="toggleLike('tweet',${t.id})">‚ô• ${likeMap[key]||0}</button>
      <button class="ghost" onclick="reply(${t.id})">Ëøî‰ø°</button>
      <span class="muted">${new Date(t.created_at).toLocaleString()}</span>
    </div>
  `;
  timeline.appendChild(div);

  all.filter(x=>x.parent_id===t.id).forEach(r=>{
    renderPost(r,all,likeMap,depth+1);
  });
}

window.reply = (id)=>{
  tweetBody.value="‚Ü© ";
  tweetBtn.onclick=()=>postTweet(id);
};

loadTimeline();
</script>
</body>
</html>
