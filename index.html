<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OSï¼ˆToDoï¼‹æ—¥è¨˜ï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;max-width:860px;margin:36px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px}
    small{color:#666}
    .card{border:1px solid #ddd;border-radius:14px;padding:12px;margin-top:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input, textarea{padding:10px;border:1px solid #ccc;border-radius:10px}
    input[type="text"]{flex:1;min-width:220px}
    textarea{width:100%;min-height:96px;resize:vertical}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    ul{padding-left:18px;margin:10px 0}
    li{margin:8px 0}
    .done{text-decoration:line-through;opacity:.6}
    .muted{opacity:.7}
    .err{color:#b00020}
    .cardSub{border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Couple OSï¼ˆå…±æœ‰ToDoï¼‹æ—¥è¨˜ / MVPï¼‰</h1>
  <small class="muted">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œã‚ãªãŸé”2äººå°‚ç”¨ã€ã€‚åˆè¨€è‘‰ã¯å›ºå®šã§ã™ã€‚</small>

  <div class="grid">
    <!-- ToDo -->
    <div class="card">
      <h2>ToDo</h2>
      <div class="row">
        <input id="txt" type="text" placeholder="ToDoã‚’å…¥åŠ›" />
        <button id="add">è¿½åŠ </button>
        <button id="reload">æ›´æ–°</button>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="status" class="muted"></small>
        <small id="error" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">21:00 æœªå®Œäº†ä¸€è¦§ï¼ˆãƒšãƒ¼ã‚¸å†…ï¼‰</h2>
        <small id="summaryGate" class="muted"></small>
        <ul id="summaryList"></ul>
      </div>

      <ul id="list"></ul>
    </div>

    <!-- Diary -->
    <div class="card">
      <h2>æ—¥è¨˜</h2>
      <div class="row">
        <label class="muted">æ—¥ä»˜</label>
        <input id="diaryDate" type="date" />
        <button id="loadDiary">è¡¨ç¤º</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="diaryTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºãªã‚‰è‡ªå‹•ã§ã€Œç„¡é¡Œã€ï¼‰" />
      </div>
      <div style="margin-top:10px">
        <textarea id="diaryBody" placeholder="æœ¬æ–‡"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveDiary">ä¿å­˜</button>
        <button id="deleteDiary">å‰Šé™¤</button>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="diaryStatus" class="muted"></small>
        <small id="diaryError" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">æœ€è¿‘ã®æ—¥è¨˜</h2>
        <ul id="diaryList"></ul>
      </div>
    </div>
  </div>

  <script>
    // ===== å›ºå®šåˆè¨€è‘‰ï¼ˆã‚ãªãŸé”2äººã ã‘ï¼‰=====
    const COUPLE_ID = "kentaria";

    // ===== Supabaseè¨­å®š =====
    const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== ToDo =====
    const txt = document.getElementById("txt");
    const addBtn = document.getElementById("add");
    const reloadBtn = document.getElementById("reload");
    const list = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const summaryGate = document.getElementById("summaryGate");
    const summaryList = document.getElementById("summaryList");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setError(msg){ errorEl.textContent = msg || ""; }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    async function fetchTodos(){
      const { data, error } = await sb
        .from("todos")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .order("created_at", { ascending: false });
      if(error) throw error;
      return data || [];
    }
    async function addTodo(title){
      const { error } = await sb
        .from("todos")
        .insert([{ couple_id: COUPLE_ID, title, done: false }]);
      if(error) throw error;
    }
    async function toggleTodo(id, done){
      const { error } = await sb.from("todos").update({ done }).eq("id", id);
      if(error) throw error;
    }
    async function deleteTodo(id){
      const { error } = await sb.from("todos").delete().eq("id", id);
      if(error) throw error;
    }

    function isAfter21(){
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      return (h > 21) || (h === 21 && m >= 0);
    }

    function renderSummary(items){
      summaryList.innerHTML = "";
      const gate = isAfter21();
      summaryGate.textContent = gate ? "21:00ä»¥é™ï¼šæœªå®Œäº†ã‚’è¡¨ç¤ºä¸­" : "21:00å‰ï¼šã“ã“ã¯ç©ºã®ã¾ã¾";
      if(!gate) return;

      const open = items.filter(x => !x.done);
      if(open.length === 0){
        const li = document.createElement("li");
        li.textContent = "æœªå®Œäº†ã¯ã‚ã‚Šã¾ã›ã‚“";
        summaryList.appendChild(li);
        return;
      }
      open.slice(0, 7).forEach(it => {
        const li = document.createElement("li");
        li.textContent = it.title;
        summaryList.appendChild(li);
      });
      if(open.length > 7){
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = `ã»ã‹ ${open.length - 7} ä»¶â€¦`;
        summaryList.appendChild(li);
      }
    }

    async function renderTodos(){
      setError("");
      list.innerHTML = "";
      summaryList.innerHTML = "";
      try{
        setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
        const items = await fetchTodos();
        setStatus(`ä»¶æ•°ï¼š${items.length}`);
        renderSummary(items);

        items.forEach(it => {
          const li = document.createElement("li");
          li.className = it.done ? "done" : "";
          li.innerHTML = `
            <label style="display:flex;gap:10px;align-items:center">
              <input type="checkbox" ${it.done ? "checked":""} />
              <span style="flex:1">${escapeHtml(it.title)}</span>
              <button>å‰Šé™¤</button>
            </label>
          `;
          li.querySelector("input").addEventListener("change", async (e)=>{
            try{ await toggleTodo(it.id, e.target.checked); renderAll(); }
            catch(err){ setError(err.message || String(err)); }
          });
          li.querySelector("button").addEventListener("click", async ()=>{
            try{ await deleteTodo(it.id); renderAll(); }
            catch(err){ setError(err.message || String(err)); }
          });
          list.appendChild(li);
        });
      }catch(err){
        setStatus("");
        setError("ToDoä¿å­˜/å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function onAdd(){
      const v = (txt.value || "").trim();
      if(!v) return;
      try{
        setError(""); setStatus("è¿½åŠ ä¸­â€¦");
        await addTodo(v);
        txt.value = "";
        renderAll();
      }catch(err){
        setStatus("");
        setError("è¿½åŠ ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    // ===== Diary =====
    const diaryDate = document.getElementById("diaryDate");
    const diaryTitle = document.getElementById("diaryTitle");
    const diaryBody = document.getElementById("diaryBody");
    const loadDiaryBtn = document.getElementById("loadDiary");
    const saveDiaryBtn = document.getElementById("saveDiary");
    const deleteDiaryBtn = document.getElementById("deleteDiary");
    const diaryStatus = document.getElementById("diaryStatus");
    const diaryError = document.getElementById("diaryError");
    const diaryList = document.getElementById("diaryList");

    function setDiaryStatus(msg){ diaryStatus.textContent = msg || ""; }
    function setDiaryError(msg){ diaryError.textContent = msg || ""; }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function fetchDiary(date){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .eq("date", date)
        .order("created_at", { ascending: false })
        .limit(1);
      if(error) throw error;
      return (data && data[0]) || null;
    }

    async function insertDiary(date, title, body){
      const { error } = await sb
        .from("diaries")
        .insert([{ couple_id: COUPLE_ID, date, title, body }]);
      if(error) throw error;
    }

    async function deleteDiaryById(id){
      const { error } = await sb.from("diaries").delete().eq("id", id);
      if(error) throw error;
    }

    async function listRecentDiaries(){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .order("created_at", { ascending: false })
        .limit(7);
      if(error) throw error;
      return data || [];
    }

    let currentDiaryId = null;

    async function loadDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      try{
        setDiaryError(""); setDiaryStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
        const d = await fetchDiary(date);
        if(!d){
          currentDiaryId = null;
          diaryTitle.value = "";
          diaryBody.value = "";
          setDiaryStatus("ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        }else{
          currentDiaryId = d.id;
          diaryTitle.value = d.title;
          diaryBody.value = d.body;
          setDiaryStatus("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
        }
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("æ—¥è¨˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function saveDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      const title = (diaryTitle.value || "").trim() || "ç„¡é¡Œ";
      const body = (diaryBody.value || "").trim();
      if(!body){ setDiaryError("æœ¬æ–‡ãŒç©ºã§ã™"); return; }

      try{
        setDiaryError(""); setDiaryStatus("ä¿å­˜ä¸­â€¦");
        await insertDiary(date, title, body);
        setDiaryStatus("ä¿å­˜ã—ã¾ã—ãŸã€‚");
        await loadDiary();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function deleteDiary(){
      if(!currentDiaryId){ setDiaryError("å‰Šé™¤ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
      try{
        setDiaryError(""); setDiaryStatus("å‰Šé™¤ä¸­â€¦");
        await deleteDiaryById(currentDiaryId);
        currentDiaryId = null;
        diaryTitle.value = "";
        diaryBody.value = "";
        setDiaryStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function renderDiaryList(){
      diaryList.innerHTML = "";
      const items = await listRecentDiaries();
      items.forEach(it => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${it.date}</b>ï¼š${escapeHtml(it.title)} <span class="muted">(${new Date(it.created_at).toLocaleString()})</span>`;
        li.style.cursor = "pointer";
        li.addEventListener("click", ()=>{
          diaryDate.value = it.date;
          loadDiary();
        });
        diaryList.appendChild(li);
      });
    }

    async function renderAll(){
      await renderTodos();
      await renderDiaryList();
    }

    // events
    addBtn.addEventListener("click", onAdd);
    reloadBtn.addEventListener("click", renderAll);
    txt.addEventListener("keydown", (e)=>{ if(e.key === "Enter") onAdd(); });

    loadDiaryBtn.addEventListener("click", loadDiary);
    saveDiaryBtn.addEventListener("click", saveDiary);
    deleteDiaryBtn.addEventListener("click", deleteDiary);

    // init
    diaryDate.value = todayISO();
    renderAll();
  </script>
</body>
</html>
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OS</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
      max-width:900px;margin:40px auto;padding:0 16px;
      background:linear-gradient(160deg,#f7f3ff,#fff);
    }
    h1{font-size:24px}
    h2{font-size:16px;margin-top:0}
    .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{padding:10px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer;background:#7b6cff;color:#fff;border:none}
    ul{padding-left:18px}
    li{margin:6px 0}
    .done{text-decoration:line-through;opacity:.5}
    .muted{opacity:.6;font-size:13px}
    .anniv{font-size:18px;color:#d6336c}
  </style>
</head>

<body>

<h1>ğŸ’‘ Couple OS</h1>

<!-- è¨˜å¿µæ—¥ -->
<div class="card">
  <div id="anniversary" class="anniv"></div>
</div>

<!-- ToDo -->
<div class="card">
  <h2>ToDo</h2>
  <div class="row">
    <input id="todoText" placeholder="ä¾‹ï¼šæ˜æ—¥ ã‚±ãƒ¼ã‚­è²·ã†" style="flex:1">
    <input id="todoDate" type="date">
    <button id="addTodo">è¿½åŠ </button>
  </div>
  <p class="muted">â€»æ—¥ä»˜ãŒãªã‘ã‚Œã°ã€Œä»Šæ—¥ã€æ‰±ã„</p>
  <ul id="todoList"></ul>
</div>

<script>
/* ===== è¨­å®š ===== */
const COUPLE_ID = "kentaria";
const START_DATE = new Date("2025-08-27");

const supabase = window.supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);

/* ===== è¨˜å¿µæ—¥è¡¨ç¤º ===== */
function renderAnniversary(){
  const today = new Date();
  if(today.getDate() !== 27) return;

  const diff = Math.floor((today - START_DATE)/86400000);
  const months =
    (today.getFullYear()-START_DATE.getFullYear())*12 +
    (today.getMonth()-START_DATE.getMonth());

  let text = `ğŸ‰ ä»˜ãåˆã£ã¦ ${months}ãƒ¶æœˆï¼ˆ${diff}æ—¥ï¼‰`;
  if(diff === 500 || diff === 1000) text += ` ğŸŠ${diff}æ—¥è¨˜å¿µï¼`;

  document.getElementById("anniversary").textContent = text;
}

/* ===== ToDo ===== */
function todayISO(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

async function loadTodos(){
  const today = todayISO();

  const { data } = await supabase
    .from("todos")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .order("due_date");

  const ul = document.getElementById("todoList");
  ul.innerHTML = "";

  data.forEach(t=>{
    const li=document.createElement("li");
    const overdue = (!t.done && t.due_date < today);
    li.className = t.done ? "done":"";
    li.innerHTML = `
      <label>
        <input type="checkbox" ${t.done?"checked":""}>
        ${t.title}
        <span class="muted">
          (${overdue ? "æŒã¡è¶Šã—" : t.due_date})
        </span>
      </label>
    `;
    li.querySelector("input").onchange=async e=>{
      await supabase.from("todos")
        .update({done:e.target.checked})
        .eq("id",t.id);
      loadTodos();
    };
    ul.appendChild(li);
  });
}

document.getElementById("addTodo").onclick=async ()=>{
  const text=document.getElementById("todoText").value.trim();
  if(!text) return;

  const dateInput=document.getElementById("todoDate").value;
  const due = dateInput || todayISO();

  await supabase.from("todos").insert([{
    couple_id:COUPLE_ID,
    title:text,
    due_date:due,
    done:false
  }]);

  document.getElementById("todoText").value="";
  document.getElementById("todoDate").value="";
  loadTodos();
};

/* ===== init ===== */
renderAnniversary();
loadTodos();
</script>

</body>
</html>
