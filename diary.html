<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Couple Timeline</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  max-width:900px;margin:auto;padding:12px;
  background:#f6f2ff;
}
h1{font-size:20px}
.card{
  background:#fff;border-radius:16px;padding:14px;margin:12px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc}
button{padding:8px 14px;border-radius:999px;border:none;background:#7b6cff;color:#fff}
.muted{font-size:13px;opacity:.7}
img{max-width:100%;border-radius:12px;margin-top:8px}
.actions{display:flex;gap:10px;margin-top:6px}
</style>
</head>

<body>
<h1>ğŸ’‘ Couple Timeline</h1>

<div class="card">
  <textarea id="tweet" placeholder="ã„ã¾ã®æ°—æŒã¡ã‚’ã²ã¨ã“ã¨â€¦"></textarea>
  <button onclick="postTweet()">æŠ•ç¨¿</button>
</div>

<div id="timeline"></div>

<script>
const sb = supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);
const COUPLE_ID = "kentaria";

async function postTweet(){
  const body = tweet.value.trim();
  if(!body) return;
  await sb.from("tweets").insert([{ couple_id:COUPLE_ID, body }]);
  tweet.value="";
  load();
}

async function toggleLike(type,id){
  const { data } = await sb.from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .eq("target_type",type)
    .eq("target_id",id)
    .maybeSingle();

  if(data){
    await sb.from("likes").delete().eq("id",data.id);
  }else{
    await sb.from("likes").insert([{ couple_id:COUPLE_ID, target_type:type, target_id:id }]);
  }
  load();
}

async function load(){
  timeline.innerHTML="èª­ã¿è¾¼ã¿ä¸­â€¦";

  const { data: diaries } = await sb.from("diaries")
    .select("*").eq("couple_id",COUPLE_ID);

  const { data: tweets } = await sb.from("tweets")
    .select("*").eq("couple_id",COUPLE_ID);

  const { data: likes } = await sb.from("likes")
    .select("*").eq("couple_id",COUPLE_ID);

  const likeMap = {};
  (likes||[]).forEach(l=>{
    likeMap[l.target_type+"_"+l.target_id]=(likeMap[l.target_type+"_"+l.target_id]||0)+1;
  });

  const items = [
    ...(diaries||[]).map(d=>({...d,type:"diary"})),
    ...(tweets||[]).map(t=>({...t,type:"tweet"}))
  ].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  timeline.innerHTML="";
  items.forEach(it=>{
    const key = it.type+"_"+it.id;
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="muted">${it.type==="diary"?"ğŸ“” æ—¥è¨˜":"ğŸ•Šï¸ ã¤ã¶ã‚„ã"}</div>
      <b>${it.title||""}</b>
      <div>${it.body||""}</div>
      ${it.image_url?`<img src="${it.image_url}">`:""}
      <div class="actions">
        <button onclick="toggleLike('${it.type}',${it.id})">â™¥ ${likeMap[key]||0}</button>
      </div>
    `;
    timeline.appendChild(div);
  });
}

load();
</script>
</body>
</html>
