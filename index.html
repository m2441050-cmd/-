<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Couple OS</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  max-width:1000px;
  margin:32px auto;
  padding:0 16px;
  background:linear-gradient(160deg,#f6f2ff,#ffffff);
}
h1{font-size:26px;margin-bottom:4px}
h2{font-size:16px;margin:0 0 8px}
.small{font-size:13px;opacity:.7}

.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
}

.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,button{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  cursor:pointer;
  background:#7b6cff;
  color:#fff;
  border:none;
}
button.sub{background:#aaa}
ul{padding-left:18px;margin:8px 0}
li{margin:6px 0}
.done{text-decoration:line-through;opacity:.5}

#calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.calHead{font-size:12px;text-align:center;opacity:.6}
.calCell{
  border:1px solid #eee;
  border-radius:12px;
  padding:8px;
  min-height:70px;
  cursor:pointer;
}
.calToday{border-color:#7b6cff}
.calSelected{outline:2px solid #7b6cff}
.dot{width:8px;height:8px;border-radius:999px;background:#7b6cff;margin-top:4px}

.anniv{font-size:18px;color:#d6336c}
</style>
</head>

<body>

<h1>ğŸ’‘ Couple OS</h1>
<div class="small">ã‚«ãƒƒãƒ—ãƒ«ã®ç”Ÿæ´»ã‚’ã²ã¨ã¤ã«</div>

<!-- åˆè¨€è‘‰ï¼ˆåˆå›ã®ã¿ï¼‰ -->
<div class="card" id="coupleCard" style="display:none">
  <h2>å…±æœ‰ID</h2>
  <div class="row">
    <input id="coupleInput" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" />
    <button id="saveCouple">ä¿å­˜</button>
  </div>
</div>

<!-- è¨˜å¿µæ—¥ -->
<div class="card" id="annivCard" style="display:none">
  <div id="annivText" class="anniv"></div>
</div>

<!-- ToDo -->
<div class="card">
  <h2>ToDo</h2>
  <div class="row">
    <input id="txt" placeholder="ä¾‹ï¼šæ˜æ—¥ 19æ™‚ ã‚±ãƒ¼ã‚­è²·ã†" style="flex:1">
    <input id="dueDate" type="date">
    <input id="dueTime" type="time">
    <button id="ai">æ•´å½¢</button>
    <button id="add">è¿½åŠ </button>
  </div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div class="row">
      <button id="prev">â†</button>
      <button id="thisMonth">ä»Šæœˆ</button>
      <button id="next">â†’</button>
    </div>
  </div>
  <div id="monthLabel" class="small"></div>
  <div id="calendar"></div>
</div>

<!-- å½“æ—¥ã®ToDo -->
<div class="card">
  <h2 id="dayLabel"></h2>
  <ul id="todoList"></ul>
</div>

<script>
/* ===== Supabase ===== */
const sb = supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);

/* ===== åˆè¨€è‘‰ ===== */
let COUPLE_ID = localStorage.getItem("couple_id");
const coupleCard = document.getElementById("coupleCard");
if(!COUPLE_ID){
  coupleCard.style.display="block";
  document.getElementById("saveCouple").onclick=()=>{
    COUPLE_ID = document.getElementById("coupleInput").value.trim();
    if(COUPLE_ID){
      localStorage.setItem("couple_id",COUPLE_ID);
      location.reload();
    }
  };
}

/* ===== è¨˜å¿µæ—¥ ===== */
const START = new Date("2025-08-27");
const today = new Date();
if(today.getDate()===27){
  const days = Math.floor((today-START)/86400000);
  const months =
    (today.getFullYear()-START.getFullYear())*12 +
    (today.getMonth()-START.getMonth());
  const years = Math.floor(months/12);
  const m = months%12;

  let text = `ğŸ‰ ä»˜ãåˆã£ã¦ ${years}å¹´${m}ãƒ¶æœˆï¼ˆ${days}æ—¥ï¼‰`;
  if([500,1000,1500].includes(days)) text += " ğŸŠ";

  document.getElementById("annivText").textContent=text;
  document.getElementById("annivCard").style.display="block";
}

/* ===== AIæ•´å½¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ ===== */
function parseAI(s){
  let t=s;
  let d=new Date();
  let time="";
  if(/æ˜æ—¥/.test(s)){d.setDate(d.getDate()+1);t=t.replace("æ˜æ—¥","");}
  const hm=s.match(/(\d{1,2})æ™‚/);
  if(hm){time=hm[1].padStart(2,"0")+":00";t=t.replace(hm[0],"");}
  return{
    title:t.trim(),
    date:d.toISOString().slice(0,10),
    time
  };
}

document.getElementById("ai").onclick=()=>{
  const r=parseAI(txt.value);
  txt.value=r.title;
  dueDate.value=r.date;
  dueTime.value=r.time;
};

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ & ToDo ===== */
let view=new Date();
let selected=view.toISOString().slice(0,10);

async function load(){
  const y=view.getFullYear(),m=view.getMonth();
  monthLabel.textContent=`${y}å¹´${m+1}æœˆ`;
  calendar.innerHTML="";
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d=>{
    const e=document.createElement("div");
    e.className="calHead";e.textContent=d;calendar.appendChild(e);
  });
  const first=new Date(y,m,1).getDay();
  for(let i=0;i<first;i++)calendar.appendChild(document.createElement("div"));
  const last=new Date(y,m+1,0).getDate();

  const {data}=await sb.from("todos").select("*")
    .eq("couple_id",COUPLE_ID);

  for(let d=1;d<=last;d++){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const c=document.createElement("div");
    c.className="calCell";
    if(iso===new Date().toISOString().slice(0,10))c.classList.add("calToday");
    if(iso===selected)c.classList.add("calSelected");
    c.textContent=d;
    if(data.some(t=>t.due_date===iso&&!t.done)){
      const dot=document.createElement("div");dot.className="dot";c.appendChild(dot);
    }
    c.onclick=()=>{selected=iso;renderDay(data);load();};
    calendar.appendChild(c);
  }
  renderDay(data);
}

async function renderDay(data){
  dayLabel.textContent=selected+" ã®ToDo";
  todoList.innerHTML="";
  data.filter(t=>t.due_date===selected).forEach(t=>{
    const li=document.createElement("li");
    li.className=t.done?"done":"";
    li.innerHTML=`<label><input type="checkbox"${t.done?"checked":""}> ${t.title}</label>`;
    li.querySelector("input").onchange=async e=>{
      await sb.from("todos").update({done:e.target.checked}).eq("id",t.id);
      load();
    };
    todoList.appendChild(li);
  });
}

document.getElementById("add").onclick=async()=>{
  await sb.from("todos").insert([{
    couple_id:COUPLE_ID,
    title:txt.value,
    due_date:dueDate.value,
    done:false
  }]);
  txt.value="";
  load();
};

prev.onclick=()=>{view.setMonth(view.getMonth()-1);load();};
next.onclick=()=>{view.setMonth(view.getMonth()+1);load();};
thisMonth.onclick=()=>{
  view=new Date();
  selected=view.toISOString().slice(0,10);
  load();
};

load();
</script>
</body>
</html>
