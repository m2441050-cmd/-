<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OSï¼ˆToDoï¼‹æ—¥è¨˜ï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;max-width:860px;margin:36px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px}
    small{color:#666}
    .card{border:1px solid #ddd;border-radius:14px;padding:12px;margin-top:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input, textarea{padding:10px;border:1px solid #ccc;border-radius:10px}
    input[type="text"]{flex:1;min-width:220px}
    textarea{width:100%;min-height:96px;resize:vertical}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    ul{padding-left:18px;margin:10px 0}
    li{margin:8px 0}
    .done{text-decoration:line-through;opacity:.6}
    .muted{opacity:.7}
    .err{color:#b00020}
    .cardSub{border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    /* Calendar */
#calendarCard { position: sticky; top: 12px; }
#calendarGrid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.calHead{
  font-size:12px;
  opacity:.6;
  text-align:center;
}
.calCell{
  border:1px solid #eee;
  border-radius:12px;
  padding:10px;
  min-height:70px;
  cursor:pointer;
  background:#fff;
}
.calCell:hover{ box-shadow:0 6px 18px rgba(0,0,0,.06); }
.calDayNum{ font-weight:700; font-size:12px; }
.calMeta{ margin-top:6px; font-size:12px; opacity:.7; }
.calSelected{ outline:2px solid rgba(123,108,255,.6); }
.calToday{ border-color: rgba(123,108,255,.5); }
.calDots{ margin-top:8px; display:flex; gap:4px; flex-wrap:wrap; }
.dot{ width:8px; height:8px; border-radius:999px; background:#7b6cff; opacity:.85; }
.dotOverdue{ background:#ff6b6b; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Couple OSï¼ˆå…±æœ‰ToDoï¼‹æ—¥è¨˜ / MVPï¼‰</h1>
  <small class="muted">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œã‚ãªãŸé”2äººå°‚ç”¨ã€ã€‚åˆè¨€è‘‰ã¯å›ºå®šã§ã™ã€‚</small>

  <div class="grid">
    <!-- ToDo -->
    <div class="card">
      <h2>ToDo</h2>
     <div class="row">
<input id="dueDate" type="date" />
<input id="dueTime" type="time" />
<button id="ai">æ•´å½¢</button>
  <button id="add">è¿½åŠ </button>
  <button id="reload">æ›´æ–°</button>
</div>
<p class="muted" style="margin:8px 0 0">â€»æ—¥ä»˜ãŒç©ºãªã‚‰ã€Œä»Šæ—¥ã€æ‰±ã„ã€‚æ•´å½¢ãƒœã‚¿ãƒ³ã§æ–‡ã‹ã‚‰æ—¥ä»˜ã‚’æ‹¾ã„ã¾ã™ã€‚</p>
      <div class="row" style="margin-top:8px">
        <small id="status" class="muted"></small>
        <small id="error" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">21:00 æœªå®Œäº†ä¸€è¦§ï¼ˆãƒšãƒ¼ã‚¸å†…ï¼‰</h2>
        <small id="summaryGate" class="muted"></small>
        <ul id="summaryList"></ul>
      </div>

    <div class="cardSub" id="calendarCard">
  <div class="row" style="justify-content:space-between">
    <h2 style="margin:0">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div class="row">
      <button id="prevMonth" type="button">â†</button>
      <button id="todayBtn" type="button">ä»Šæ—¥</button>
      <button id="nextMonth" type="button">â†’</button>
    </div>
  </div>

  <div class="row" style="justify-content:space-between;margin-top:8px">
    <div class="muted" id="monthLabel"></div>
    <div class="muted" id="selectedLabel"></div>
  </div>

  <div id="calendarGrid" style="margin-top:10px"></div>
</div>
      <ul id="list"></ul>
    </div>

    <!-- Diary -->
    <div class="card">
      <h2>æ—¥è¨˜</h2>
      <div class="row">
        <label class="muted">æ—¥ä»˜</label>
        <input id="diaryDate" type="date" />
        <button id="loadDiary">è¡¨ç¤º</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="diaryTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºãªã‚‰è‡ªå‹•ã§ã€Œç„¡é¡Œã€ï¼‰" />
      </div>
      <div style="margin-top:10px">
        <textarea id="diaryBody" placeholder="æœ¬æ–‡"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveDiary">ä¿å­˜</button>
        <button id="deleteDiary">å‰Šé™¤</button>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="diaryStatus" class="muted"></small>
        <small id="diaryError" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">æœ€è¿‘ã®æ—¥è¨˜</h2>
        <ul id="diaryList"></ul>
      </div>
    </div>
  </div>

  <script>
    // ===== å›ºå®šåˆè¨€è‘‰ï¼ˆã‚ãªãŸé”2äººã ã‘ï¼‰=====
    const COUPLE_ID = "kentaria";

    // ===== Supabaseè¨­å®š =====
    const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  
 // ===== ToDoï¼ˆdue_dateå¯¾å¿œ + AIæ•´å½¢ + ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ =====
const txt = document.getElementById("txt");
const dueDateInput = document.getElementById("dueDate");
const aiBtn = document.getElementById("ai");
const addBtn = document.getElementById("add");
const reloadBtn = document.getElementById("reload");
const list = document.getElementById("list");
const statusEl = document.getElementById("status");
const errorEl = document.getElementById("error");

// Calendar UI
const prevMonthBtn = document.getElementById("prevMonth");
const nextMonthBtn = document.getElementById("nextMonth");
const todayBtn = document.getElementById("todayBtn");
const monthLabel = document.getElementById("monthLabel");
const selectedLabel = document.getElementById("selectedLabel");
const calendarGrid = document.getElementById("calendarGrid");

function setStatus(msg){ statusEl.textContent = msg || ""; }
function setError(msg){ errorEl.textContent = msg || ""; }

function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function fromISODate(s){
  const [y,m,dd] = s.split("-").map(Number);
  return new Date(y, m-1, dd);
}
function todayISO(){ return toISODate(new Date()); }

// ã€Œæœªå®Œäº†ã¯ç¿Œæ—¥ã«æŒã¡è¶Šã—ã€ï¼å®Ÿè£…ä¸Šã¯ã€Œä»Šæ—¥é–‹ã„ãŸã‚‰éå»åˆ†ã‚’ä»Šæ—¥ã«ç§»ã™ã€
async function carryOverOverdue(){
  const today = todayISO();
  const { error } = await sb
    .from("todos")
    .update({ due_date: today })
    .eq("couple_id", COUPLE_ID)
    .eq("done", false)
    .lt("due_date", today);

  if(error) throw error;
}

// æœŸé–“ã§ToDoå–å¾—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ï¼‰
async function fetchTodosBetween(startISO, endISO){
  const { data, error } = await sb
    .from("todos")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .gte("due_date", startISO)
    .lte("due_date", endISO)
    .order("due_date", { ascending: true })
    .order("created_at", { ascending: false });

  if(error) throw error;
  return data || [];
}

async function addTodo(title, due_date){
  const { error } = await sb.from("todos").insert([{
    couple_id: COUPLE_ID,
    title,
    due_date,
    done: false
  }]);
  if(error) throw error;
}

async function toggleTodo(id, done){
  const { error } = await sb.from("todos").update({ done }).eq("id", id);
  if(error) throw error;
}

async function deleteTodo(id){
  const { error } = await sb.from("todos").delete().eq("id", id);
  if(error) throw error;
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/**
 * ç–‘ä¼¼AIæ•´å½¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
 * ä¾‹ï¼š
 *  - "æ˜æ—¥ ã‚±ãƒ¼ã‚­è²·ã†" -> due=tomorrow
 *  - "1/5 ç—…é™¢ã«é›»è©±" -> due=ä»Šå¹´ã®1/5ï¼ˆéãã¦ãŸã‚‰æ¥å¹´ï¼‰
 *  - "2026/1/5 â—‹â—‹" -> due=ãã®æ—¥
 *  - æ—¥ä»˜ç„¡ã— -> ä»Šæ—¥
 */
function localAIParse(input){
  let s = (input || "").trim();
  const now = new Date();
  let due = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let time = "";

  // æ™‚åˆ»ï¼ˆ19æ™‚ / 19:30 / 7:00ï¼‰
  const hm = s.match(/(\d{1,2})(?:æ™‚|:)(\d{2})?/);
  if(hm){
    const h = Number(hm[1]);
    const m = hm[2] ? Number(hm[2]) : 0;
    time = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    s = s.replace(hm[0],"").trim();
  }

  // ä»Šæ—¥/æ˜æ—¥/æ˜å¾Œæ—¥
  if(/æ˜å¾Œæ—¥/.test(s)){ due.setDate(due.getDate()+2); s=s.replace("æ˜å¾Œæ—¥",""); }
  else if(/æ˜æ—¥/.test(s)){ due.setDate(due.getDate()+1); s=s.replace("æ˜æ—¥",""); }

  // YYYY/MM/DD
  const ymd = s.match(/(20\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if(ymd){
    due = new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
    s = s.replace(ymd[0],"").trim();
  }

  const title = s.replace(/\s+/g," ").trim() || "ToDo";

  return {
    title,
    due_date: toISODate(due),
    due_time: time
  };
}
  }

  // ã‚¿ã‚¤ãƒˆãƒ«æ•´å½¢ï¼ˆè¶…è»½ã„ï¼‰
  let title = s
    .replace(/\s+/g," ")
    .replace(/^[:ï¼š\-\â€“\â€”]+/,"")
    .trim();

  if(!title) title = "ToDo";

  return { title, due_date: toISODate(due) };
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ï¼šä»Šè¦‹ã¦ã‚‹æœˆ
let viewYear = (new Date()).getFullYear();
let viewMonth = (new Date()).getMonth(); // 0-11
let selectedDateISO = todayISO();
let monthTodosCache = []; // ãã®æœˆã®todos

function monthRangeISO(y, m){
  const start = new Date(y, m, 1);
  const end = new Date(y, m+1, 0); // æœˆæœ«
  return { startISO: toISODate(start), endISO: toISODate(end) };
}

function groupByDate(todos){
  const map = new Map();
  for(const t of todos){
    if(!map.has(t.due_date)) map.set(t.due_date, []);
    map.get(t.due_date).push(t);
  }
  return map;
}

function buildCalendar(y, m, todos){
  calendarGrid.innerHTML = "";

  const heads = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  for(const h of heads){
    const el = document.createElement("div");
    el.className = "calHead";
    el.textContent = h;
    calendarGrid.appendChild(el);
  }

  monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;
  selectedLabel.textContent = `é¸æŠä¸­ï¼š${selectedDateISO}`;

  const first = new Date(y, m, 1);
  const startDow = first.getDay(); // 0=Sun
  const daysInMonth = new Date(y, m+1, 0).getDate();

  const today = todayISO();
  const byDate = groupByDate(todos);

  // ç©ºã‚»ãƒ«
  for(let i=0;i<startDow;i++){
    const spacer = document.createElement("div");
    spacer.style.minHeight = "70px";
    calendarGrid.appendChild(spacer);
  }

  for(let day=1; day<=daysInMonth; day++){
    const iso = `${y}-${pad2(m+1)}-${pad2(day)}`;
    const cell = document.createElement("div");
    cell.className = "calCell";

    if(iso === selectedDateISO) cell.classList.add("calSelected");
    if(iso === today) cell.classList.add("calToday");

    const items = byDate.get(iso) || [];
    const open = items.filter(x=>!x.done);
    const overdueOpen = open.filter(x=>x.due_date < today);

    const num = document.createElement("div");
    num.className = "calDayNum";
    num.textContent = day;

    const meta = document.createElement("div");
    meta.className = "calMeta";
    meta.textContent = open.length ? `æœªå®Œäº† ${open.length}ä»¶` : " ";

    const dots = document.createElement("div");
    dots.className = "calDots";
    // æœ€å¤§6å€‹ã ã‘ãƒ‰ãƒƒãƒˆ
    const show = open.slice(0,6);
    show.forEach(t=>{
      const d = document.createElement("span");
      d.className = "dot" + (t.due_date < today ? " dotOverdue" : "");
      dots.appendChild(d);
    });

    cell.appendChild(num);
    cell.appendChild(meta);
    cell.appendChild(dots);

    cell.addEventListener("click", ()=>{
      selectedDateISO = iso;
      dueDateInput.value = iso; // å…¥åŠ›ã«ã‚‚åæ˜ ï¼ˆä¾¿åˆ©ï¼‰
      selectedLabel.textContent = `é¸æŠä¸­ï¼š${selectedDateISO}`;
      renderTodoListForSelected();
      buildCalendar(viewYear, viewMonth, monthTodosCache);
    });

    calendarGrid.appendChild(cell);
  }


function renderTodoListForSelected(){
  const iso = selectedDateISO;
  const today = todayISO();
  list.innerHTML = "";

  // é¸æŠæ—¥ã®ToDo + ï¼ˆéå»æœªå®Œäº†ã¯ã€ŒæŒã¡è¶Šã—ã€æ‰±ã„ã§ä»Šæ—¥ã«é›†ç´„ã™ã‚‹è¨­è¨ˆãªã®ã§ã€ã“ã“ã§ã¯ãã®æ—¥åˆ†ã®ã¿ï¼‰
  const items = monthTodosCache.filter(t => t.due_date === iso);

  if(items.length === 0){
    const li = document.createElement("li");
    li.className = "muted";
    li.textContent = "ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“";
    list.appendChild(li);
    return;
  }

  items.forEach(it=>{
    const li = document.createElement("li");
    li.className = it.done ? "done" : "";
    li.innerHTML = `
      <label style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" ${it.done ? "checked":""} />
        <span style="flex:1">${escapeHtml(it.title)}</span>
        <button type="button">å‰Šé™¤</button>
      </label>
    `;

    li.querySelector("input").addEventListener("change", async (e)=>{
      try{ await toggleTodo(it.id, e.target.checked); await reloadMonth(); }
      catch(err){ setError(err.message || String(err)); }
    });

    li.querySelector("button").addEventListener("click", async ()=>{
      try{ await deleteTodo(it.id); await reloadMonth(); }
      catch(err){ setError(err.message || String(err)); }
    });

    list.appendChild(li);
  });
}

async function reloadMonth(){
  setError("");
  try{
    setStatus("åŒæœŸä¸­â€¦ï¼ˆæœªå®Œäº†ã®æŒã¡è¶Šã—å‡¦ç†ã‚‚å®Ÿè¡Œï¼‰");
    await carryOverOverdue();

    const { startISO, endISO } = monthRangeISO(viewYear, viewMonth);
    monthTodosCache = await fetchTodosBetween(startISO, endISO);

    setStatus("OK");
    buildCalendar(viewYear, viewMonth, monthTodosCache);
    renderTodoListForSelected();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
}

async function onAdd(){
  const raw = (txt.value || "").trim();
  if(!raw) return;

  // æ—¥ä»˜å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œå„ªå…ˆã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«AIã§æ‹¾ã†
  let title = raw;
  let due = dueDateInput.value || "";

  if(!due){
    const parsed = localAIParse(raw);
    title = parsed.title;
    due = parsed.due_date;
  }else{
    // å…¥åŠ›æ—¥ä»˜ãŒã‚ã‚‹ãªã‚‰ã€ã‚¿ã‚¤ãƒˆãƒ«ã ã‘è»½ãæ•´ãˆã‚‹
    title = raw.replace(/\s+/g," ").trim();
  }

  try{
    setError(""); setStatus("è¿½åŠ ä¸­â€¦");
    await addTodo(title, due);
    txt.value = "";
    // è¿½åŠ å¾Œã¯ãã®æ—¥ã‚’é¸æŠ
    selectedDateISO = due;
    dueDateInput.value = due;
    // è¡¨ç¤ºæœˆã‚‚åˆã‚ã›ã‚‹
    const d = fromISODate(due);
    viewYear = d.getFullYear();
    viewMonth = d.getMonth();
    await reloadMonth();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
}

function onAI(){
  const raw = txt.value.trim();
  if(!raw) return;
  const p = localAIParse(raw);
  txt.value = p.title;
  dueDateInput.value = p.due_date;
  dueTimeInput.value = p.due_time;
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ“ä½œ
prevMonthBtn.addEventListener("click", async ()=>{
  viewMonth -= 1;
  if(viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
  const first = new Date(viewYear, viewMonth, 1);
  selectedDateISO = toISODate(first);
  dueDateInput.value = selectedDateISO;
  await reloadMonth();
});
nextMonthBtn.addEventListener("click", async ()=>{
  viewMonth += 1;
  if(viewMonth > 11){ viewMonth = 0; viewYear += 1; }
  const first = new Date(viewYear, viewMonth, 1);
  selectedDateISO = toISODate(first);
  dueDateInput.value = selectedDateISO;
  await reloadMonth();
});
todayBtn.addEventListener("click", async ()=>{
  const t = new Date();
  viewYear = t.getFullYear();
  viewMonth = t.getMonth();
  selectedDateISO = todayISO();
  dueDateInput.value = selectedDateISO;
  await reloadMonth();
});

// æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆ
aiBtn.addEventListener("click", onAI);
addBtn.addEventListener("click", onAdd);
reloadBtn.addEventListener("click", reloadMonth);
txt.addEventListener("keydown", (e)=>{ if(e.key === "Enter") onAdd(); });

// initï¼ˆãƒšãƒ¼ã‚¸èµ·å‹•æ™‚ï¼‰
dueDateInput.value = selectedDateISO;
reloadMonth();

    // ===== Diary =====
    const diaryDate = document.getElementById("diaryDate");
    const diaryTitle = document.getElementById("diaryTitle");
    const diaryBody = document.getElementById("diaryBody");
    const loadDiaryBtn = document.getElementById("loadDiary");
    const saveDiaryBtn = document.getElementById("saveDiary");
    const deleteDiaryBtn = document.getElementById("deleteDiary");
    const diaryStatus = document.getElementById("diaryStatus");
    const diaryError = document.getElementById("diaryError");
    const diaryList = document.getElementById("diaryList");

    function setDiaryStatus(msg){ diaryStatus.textContent = msg || ""; }
    function setDiaryError(msg){ diaryError.textContent = msg || ""; }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function fetchDiary(date){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .eq("date", date)
        .order("created_at", { ascending: false })
        .limit(1);
      if(error) throw error;
      return (data && data[0]) || null;
    }

    async function insertDiary(date, title, body){
      const { error } = await sb
        .from("diaries")
        .insert([{ couple_id: COUPLE_ID, date, title, body }]);
      if(error) throw error;
    }

    async function deleteDiaryById(id){
      const { error } = await sb.from("diaries").delete().eq("id", id);
      if(error) throw error;
    }

    async function listRecentDiaries(){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .order("created_at", { ascending: false })
        .limit(7);
      if(error) throw error;
      return data || [];
    }

    let currentDiaryId = null;

    async function loadDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      try{
        setDiaryError(""); setDiaryStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
        const d = await fetchDiary(date);
        if(!d){
          currentDiaryId = null;
          diaryTitle.value = "";
          diaryBody.value = "";
          setDiaryStatus("ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        }else{
          currentDiaryId = d.id;
          diaryTitle.value = d.title;
          diaryBody.value = d.body;
          setDiaryStatus("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
        }
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("æ—¥è¨˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function saveDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      const title = (diaryTitle.value || "").trim() || "ç„¡é¡Œ";
      const body = (diaryBody.value || "").trim();
      if(!body){ setDiaryError("æœ¬æ–‡ãŒç©ºã§ã™"); return; }

      try{
        setDiaryError(""); setDiaryStatus("ä¿å­˜ä¸­â€¦");
        await insertDiary(date, title, body);
        setDiaryStatus("ä¿å­˜ã—ã¾ã—ãŸã€‚");
        await loadDiary();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function deleteDiary(){
      if(!currentDiaryId){ setDiaryError("å‰Šé™¤ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
      try{
        setDiaryError(""); setDiaryStatus("å‰Šé™¤ä¸­â€¦");
        await deleteDiaryById(currentDiaryId);
        currentDiaryId = null;
        diaryTitle.value = "";
        diaryBody.value = "";
        setDiaryStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
      }
    }

    async function renderDiaryList(){
      diaryList.innerHTML = "";
      const items = await listRecentDiaries();
      items.forEach(it => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${it.date}</b>ï¼š${escapeHtml(it.title)} <span class="muted">(${new Date(it.created_at).toLocaleString()})</span>`;
        li.style.cursor = "pointer";
        li.addEventListener("click", ()=>{
          diaryDate.value = it.date;
          loadDiary();
        });
        diaryList.appendChild(li);
      });
    }

    async function renderAll(){
      await renderTodos();
      await renderDiaryList();
    }

    // events
    addBtn.addEventListener("click", onAdd);
    reloadBtn.addEventListener("click", renderAll);
    txt.addEventListener("keydown", (e)=>{ if(e.key === "Enter") onAdd(); });

    loadDiaryBtn.addEventListener("click", loadDiary);
    saveDiaryBtn.addEventListener("click", saveDiary);
    deleteDiaryBtn.addEventListener("click", deleteDiary);

    // init
    diaryDate.value = todayISO();
    renderAll();
  </script>
</body>
</html>
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OS</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
      max-width:900px;margin:40px auto;padding:0 16px;
      background:linear-gradient(160deg,#f7f3ff,#fff);
    }
    h1{font-size:24px}
    h2{font-size:16px;margin-top:0}
    .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{padding:10px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer;background:#7b6cff;color:#fff;border:none}
    ul{padding-left:18px}
    li{margin:6px 0}
    .done{text-decoration:line-through;opacity:.5}
    .muted{opacity:.6;font-size:13px}
    .anniv{font-size:18px;color:#d6336c}
  </style>
</head>

<body>

<h1>ğŸ’‘ Couple OS</h1>

<!-- è¨˜å¿µæ—¥ -->
<div class="card">
  <div id="anniversary" class="anniv"></div>
</div>

<!-- ToDo -->
<div class="card">
  <h2>ToDo</h2>
  <div class="row">
    <input id="todoText" placeholder="ä¾‹ï¼šæ˜æ—¥ ã‚±ãƒ¼ã‚­è²·ã†" style="flex:1">
    <input id="todoDate" type="date">
    <button id="addTodo">è¿½åŠ </button>
  </div>
  <p class="muted">â€»æ—¥ä»˜ãŒãªã‘ã‚Œã°ã€Œä»Šæ—¥ã€æ‰±ã„</p>
  <ul id="todoList"></ul>
</div>

<script>
/* ===== è¨­å®š ===== */
const COUPLE_ID = "kentaria";
const START_DATE = new Date("2025-08-27");

const supabase = window.supabase.createClient(
  "https://eycneuftjdooykzjbioy.supabase.co",
  "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z"
);

/* ===== è¨˜å¿µæ—¥è¡¨ç¤º ===== */
function renderAnniversary(){
  const today = new Date();
  if(today.getDate() !== 27) return;

  const diff = Math.floor((today - START_DATE)/86400000);
  const months =
    (today.getFullYear()-START_DATE.getFullYear())*12 +
    (today.getMonth()-START_DATE.getMonth());

  let text = `ğŸ‰ ä»˜ãåˆã£ã¦ ${months}ãƒ¶æœˆï¼ˆ${diff}æ—¥ï¼‰`;
  if(diff === 500 || diff === 1000) text += ` ğŸŠ${diff}æ—¥è¨˜å¿µï¼`;

  document.getElementById("anniversary").textContent = text;
}

/* ===== ToDo ===== */
function todayISO(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

async function loadTodos(){
  const today = todayISO();

  const { data } = await supabase
    .from("todos")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .order("due_date");

  const ul = document.getElementById("todoList");
  ul.innerHTML = "";

  data.forEach(t=>{
    const li=document.createElement("li");
    const overdue = (!t.done && t.due_date < today);
    li.className = t.done ? "done":"";
    li.innerHTML = `
      <label>
        <input type="checkbox" ${t.done?"checked":""}>
        ${t.title}
        <span class="muted">
          (${overdue ? "æŒã¡è¶Šã—" : t.due_date})
        </span>
      </label>
    `;
    li.querySelector("input").onchange=async e=>{
      await supabase.from("todos")
        .update({done:e.target.checked})
        .eq("id",t.id);
      loadTodos();
    };
    ul.appendChild(li);
  });
}

document.getElementById("addTodo").onclick=async ()=>{
  const text=document.getElementById("todoText").value.trim();
  if(!text) return;

  const dateInput=document.getElementById("todoDate").value;
  const due = dateInput || todayISO();

  await supabase.from("todos").insert([{
    couple_id:COUPLE_ID,
    title:text,
    due_date:due,
    done:false
  }]);

  document.getElementById("todoText").value="";
  document.getElementById("todoDate").value="";
  loadTodos();
};

/* ===== init ===== */
renderAnniversary();
loadTodos();
</script>

</body>
</html>
