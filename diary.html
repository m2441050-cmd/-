<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Timeline - Couple OS</title>

<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  max-width:900px;margin:0 auto;padding:12px;
  background:#f6f2ff;
}
h1{font-size:20px;margin:0}
.muted{opacity:.7;font-size:13px}
.err{color:#b00020;font-size:13px}
.ok{color:#0b7a35;font-size:13px}

.card{
  background:#fff;border-radius:16px;padding:14px;margin:12px 0;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
textarea,input{
  width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;
}
button{
  padding:8px 14px;border-radius:999px;
  border:none;background:#7b6cff;color:#fff;
}
button.ghost{background:#fff;color:#333;border:1px solid #ddd}
img{max-width:100%;border-radius:12px;margin-top:8px}

.post{border-bottom:1px solid #eee;padding-bottom:12px;margin-bottom:12px}
.actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.small{font-size:12px}
</style>
</head>

<body>

<h1>üïäÔ∏è „Çø„Ç§„É†„É©„Ç§„É≥</h1>
<div class="muted">Êó•Ë®ò„ÉªÂÜôÁúü„Éª„Å§„Å∂„ÇÑ„Åç„Éª„ÅÑ„ÅÑ„Å≠</div>

<div class="card">
  <textarea id="tweetBody" placeholder="‰ªä„ÅÆÊ∞óÊåÅ„Å°„Çí‰∏ÄË®Ä‚Ä¶"></textarea>
  <button id="tweetBtn">ÊäïÁ®ø</button>
  <div class="err" id="err"></div>
  <div class="ok" id="ok"></div>
</div>

<div class="card">
  <label class="muted">Êúà„ÅßÁµû„ÇäËæº„Åø</label>
  <input type="month" id="month">
</div>

<div id="timeline"></div>

<script>
const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
const COUPLE_ID = "kentaria";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const timeline = document.getElementById("timeline");
const errEl = document.getElementById("err");
const okEl = document.getElementById("ok");

function esc(s){return (s||"").replace(/[&<>"']/g,c=>(
{"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]
));}

function monthRange(m){
  if(!m){
    const d=new Date();
    m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  const [y,mm]=m.split("-");
  return {
    start:`${y}-${mm}-01`,
    end:`${y}-${mm}-31`
  };
}

async function postTweet(){
  errEl.textContent=""; okEl.textContent="";
  const body = tweetBody.value.trim();
  if(!body){ errEl.textContent="Á©∫„Åß„Åô"; return; }

  const { error } = await sb.from("tweets").insert([{
    couple_id:COUPLE_ID,
    body
  }]);
  if(error){ errEl.textContent=error.message; return; }

  tweetBody.value="";
  okEl.textContent="ÊäïÁ®ø„Åó„Åæ„Åó„Åü";
  loadTimeline();
}

tweetBtn.onclick = postTweet;

async function toggleLike(type,id){
  const { data } = await sb.from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .eq("target_type",type)
    .eq("target_id",id)
    .maybeSingle();

  if(data){
    await sb.from("likes").delete().eq("id",data.id);
  }else{
    await sb.from("likes").insert([{
      couple_id:COUPLE_ID,
      target_type:type,
      target_id:id
    }]);
  }
  loadTimeline();
}

async function loadTimeline(){
  timeline.innerHTML="Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";
  const { start, end } = monthRange(month.value);

  const { data: diaries } = await sb
    .from("diaries")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .gte("date",start)
    .lte("date",end)
    .order("created_at",{ascending:false});

  const { data: tweets } = await sb
    .from("tweets")
    .select("*")
    .eq("couple_id",COUPLE_ID)
    .order("created_at",{ascending:false});

  const { data: likes } = await sb
    .from("likes")
    .select("*")
    .eq("couple_id",COUPLE_ID);

  const likeMap={};
  likes.forEach(l=>{
    likeMap[l.target_type+"_"+l.target_id]=(likeMap[l.target_type+"_"+l.target_id]||0)+1;
  });

  const items=[
    ...(diaries||[]).map(d=>({...d,type:"diary"})),
    ...(tweets||[]).map(t=>({...t,type:"tweet"}))
  ].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  timeline.innerHTML="";
  items.forEach(it=>{
    const key=it.type+"_"+it.id;
    const div=document.createElement("div");
    div.className="card post";
    div.innerHTML=`
      <div class="small muted">${it.type==="diary"?"üìî Êó•Ë®ò":"üïäÔ∏è „Å§„Å∂„ÇÑ„Åç"} / ${new Date(it.created_at).toLocaleString()}</div>
      <div>${esc(it.title||"")}</div>
      <div>${esc(it.body||"")}</div>
      ${it.image_url?`<img src="${esc(it.image_url)}">`:""}
      <div class="actions small">
        <button onclick="toggleLike('${it.type}',${it.id})">‚ô• ${likeMap[key]||0}</button>
      </div>
    `;
    timeline.appendChild(div);
  });
}

month.onchange = loadTimeline;
loadTimeline();
</script>
</body>
</html>
