<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
      max-width:1080px;margin:28px auto;padding:0 16px;
      background:linear-gradient(160deg,#f6f2ff,#ffffff);
    }
    h1{font-size:26px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 10px}
    .muted{opacity:.7;font-size:13px}
    .err{color:#b00020;font-size:13px}
    .card{
      background:#fff;border-radius:18px;padding:16px;margin:14px 0;
      box-shadow:0 12px 30px rgba(0,0,0,.06);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button,textarea{
      padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:14px;
    }
    button{cursor:pointer;background:#7b6cff;color:#fff;border:none}
    button.sub{background:#aaa}
    button.ghost{background:#fff;color:#333;border:1px solid #ddd}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

    #calendarWrap{position:sticky;top:10px}
    #calendarGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .calHead{font-size:12px;opacity:.6;text-align:center}
    .calCell{
      border:1px solid #eee;border-radius:12px;padding:10px;min-height:76px;
      cursor:pointer;background:#fff;
    }
    .calCell:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .calToday{border-color:rgba(123,108,255,.7)}
    .calSelected{outline:2px solid rgba(123,108,255,.7)}
    .calNum{font-weight:700;font-size:12px}
    .calMeta{margin-top:6px;font-size:12px;opacity:.75}
    .dots{margin-top:8px;display:flex;gap:4px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:999px;background:#7b6cff;opacity:.85}

    ul{padding-left:18px;margin:8px 0}
    li{margin:6px 0}
    .done{text-decoration:line-through;opacity:.55}
    .anniv{font-size:18px;color:#d6336c}
  </style>
</head>

<body>
  <h1>ğŸ’‘ Couple OS</h1>
  <div class="muted">ã‚«ãƒƒãƒ—ãƒ«ã®ç”Ÿæ´»ã‚’ã²ã¨ã¤ã«</div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ã ã‘è¡¨ç¤ºï¼‰ -->
  <div class="card" id="loginCard" style="display:none">
    <h2>å…±æœ‰ID</h2>
    <div class="row">
      <input id="coupleInput" placeholder="kentaria" style="flex:1;min-width:220px" />
      <button id="saveCouple" type="button">ä¿å­˜</button>
      <button id="clearCouple" type="button" class="ghost">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="muted">â€»ä¸€åº¦ä¿å­˜ã—ãŸã‚‰ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ã™ã‚‹ã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
    <div class="err" id="loginErr"></div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã ã‘è¡¨ç¤ºï¼‰ -->
  <div id="app" style="display:none">
    <!-- â–¼ èƒŒæ™¯è¨­å®šï¼ˆ2äººã§å…±æœ‰ï¼‰ -->
<div class="card">
  <h2>èƒŒæ™¯</h2>
  <div class="row">
    <input id="bgUrl" placeholder="ç”»åƒURLï¼ˆhttps://...jpgï¼‰" style="flex:1;min-width:220px">
    <button id="saveBg" type="button">èƒŒæ™¯ã‚’ä¿å­˜</button>
  </div>
  <div class="muted" style="margin-top:8px">
    â€»URLã‚’ä¿å­˜ã™ã‚‹ã¨2äººã®ç”»é¢ãŒåŒã˜èƒŒæ™¯ã«ãªã‚Šã¾ã™ï¼ˆindex/diaryé€£å‹•ï¼‰
  </div>
  <div class="err" id="bgErr"></div>
</div>

    <!-- è¨˜å¿µæ—¥ï¼ˆ27æ—¥ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="card" id="annivCard" style="display:none">
      <div id="annivText" class="anniv"></div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šToDoï¼‹æ—¥è¨˜ -->
      <div>
        <div class="card">
          <h2>ToDo</h2>
          <div class="row">
            <input id="txt" placeholder="ä¾‹ï¼š4æ—¥8æ™‚ ãŠåœŸç”£è²·ã† / æ˜æ—¥ 19æ™‚ ã‚±ãƒ¼ã‚­è²·ã†" style="flex:1;min-width:240px" />
            <input id="dueDate" type="date" />
            <input id="dueTime" type="time" />
            <button id="ai" type="button">æ•´å½¢</button>
            <button id="add" type="button">è¿½åŠ </button>
          </div>
          <div class="muted" style="margin-top:8px">â€»æ—¥ä»˜ãŒç©ºãªã‚‰ã€å…¥åŠ›æ–‡ã‹ã‚‰æ‹¾ã„ã¾ã™ï¼ˆæ•´å½¢ã‚’æŠ¼ã•ãªãã¦ã‚‚OKï¼‰ã€‚</div>
          <div class="row" style="margin-top:10px">
            <div class="muted" id="status"></div>
            <div class="err" id="error"></div>
          </div>
        </div>

        <div class="card">
          <h2 id="dayLabel">é¸æŠæ—¥ã®ToDo</h2>
          <ul id="todoList"></ul>
        </div>

        <div class="card">
          <h2>æ—¥è¨˜</h2>
          <div class="row">
            <label class="muted">æ—¥ä»˜</label>
            <input id="diaryDate" type="date" />
            <button id="loadDiary" type="button" class="ghost">è¡¨ç¤º</button>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="diaryTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºãªã‚‰ç„¡é¡Œï¼‰" style="flex:1;min-width:240px" />
          </div>
          <div class="row" style="margin-top:6px">
  <input id="diaryTags" type="text"
    placeholder="ã‚¿ã‚°ï¼ˆä¾‹ï¼šæ—…è¡Œ,å¹¸ã›,ä½“èª¿ï¼‰"
    style="flex:1" />
</div>
          <div style="margin-top:10px">
            <textarea id="diaryBody" placeholder="æœ¬æ–‡" style="width:100%;min-height:120px;resize:vertical"></textarea>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="saveDiary" type="button">ä¿å­˜</button>
            <button id="deleteDiary" type="button" class="sub">å‰Šé™¤</button>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="muted" id="diaryStatus"></div>
            <div class="err" id="diaryError"></div>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid #eee;margin-top:12px">
            <button type="button" class="ghost" onclick="location.href='./diary.html'">æ—¥è¨˜ã‚’è¦‹è¿”ã™ï¼ˆä¸€è¦§ï¼‰</button>
            <h2 style="margin:0 0 6px">æœ€è¿‘ã®æ—¥è¨˜</h2>
            <ul id="diaryList"></ul>
          </div>
        </div>
      </div>

      <!-- å³ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div id="calendarWrap">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
            <div class="row">
              <button id="prev" type="button">â†</button>
              <button id="thisMonth" type="button">ä»Šæœˆ</button>
              <button id="next" type="button">â†’</button>
            </div>
          </div>
          <div class="row" style="justify-content:space-between;margin-top:8px">
            <div class="muted" id="monthLabel"></div>
            <div class="muted" id="selectedLabel"></div>
          </div>
          <div id="calendarGrid" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="muted">ãƒ­ã‚°ã‚¤ãƒ³è§£é™¤ã—ãŸã„æ™‚</div>
            <button id="logout" class="ghost" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== è¨˜å¿µæ—¥åŸºæº– ===== */
const START_DATE = new Date("2025-08-27T00:00:00");

/* ===== DOM ===== */
const loginCard = document.getElementById("loginCard");
const app = document.getElementById("app");
const coupleInput = document.getElementById("coupleInput");
const saveCouple = document.getElementById("saveCouple");
const clearCouple = document.getElementById("clearCouple");
const loginErr = document.getElementById("loginErr");

const annivCard = document.getElementById("annivCard");
const annivText = document.getElementById("annivText");

const txtEl = document.getElementById("txt");
const dueDateEl = document.getElementById("dueDate");
const dueTimeEl = document.getElementById("dueTime");
const aiBtn = document.getElementById("ai");
const addBtn = document.getElementById("add");
const statusEl = document.getElementById("status");
const errorEl = document.getElementById("error");

const monthLabelEl = document.getElementById("monthLabel");
const selectedLabelEl = document.getElementById("selectedLabel");
const calendarGridEl = document.getElementById("calendarGrid");
const dayLabelEl = document.getElementById("dayLabel");
const todoListEl = document.getElementById("todoList");

const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const thisMonthBtn = document.getElementById("thisMonth");
const logoutBtn = document.getElementById("logout");

/* æ—¥è¨˜DOM */
const diaryDateEl = document.getElementById("diaryDate");
const diaryTitleEl = document.getElementById("diaryTitle");
const diaryBodyEl = document.getElementById("diaryBody");
const loadDiaryBtn = document.getElementById("loadDiary");
const saveDiaryBtn = document.getElementById("saveDiary");
const deleteDiaryBtn = document.getElementById("deleteDiary");
const diaryStatusEl = document.getElementById("diaryStatus");
const diaryErrorEl = document.getElementById("diaryError");
const diaryListEl = document.getElementById("diaryList");

/* ===== çŠ¶æ…‹ ===== */
let COUPLE_ID = localStorage.getItem("couple_id") || "";
let viewYear, viewMonth;
let selectedISO = "";
let monthTodos = [];
let currentDiaryId = null;

/* ===== utils ===== */
const pad2 = (n)=> String(n).padStart(2,"0");
const toISO = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const todayISO = ()=> toISO(new Date());
const fromISO = (s)=> { const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); };

function setStatus(s){ statusEl.textContent = s || ""; }
function setError(s){ errorEl.textContent = s || ""; }
function setDiaryStatus(s){ diaryStatusEl.textContent = s || ""; }
function setDiaryError(s){ diaryErrorEl.textContent = s || ""; }

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
/* ===== èƒŒæ™¯ï¼ˆcouple_settingsï¼‰ ===== */
const bgErrEl = document.getElementById("bgErr");

async function loadBackground(){
  try{
    // couple_idã§1ä»¶å–å¾—
    const { data, error } = await sb
      .from("couple_settings")
      .select("*")
      .eq("couple_id", COUPLE_ID)
      .maybeSingle();

    if(error) throw error;

    if(data && data.background_url){
      document.body.style.background = `url(${data.background_url}) center/cover fixed`;
    }else{
      // èƒŒæ™¯æœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆä»»æ„ï¼‰
      document.body.style.background = "linear-gradient(160deg,#f6f2ff,#ffffff)";
    }
  }catch(err){
    if(bgErrEl) bgErrEl.textContent = "èƒŒæ™¯èª­è¾¼ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err));
  }
}

async function saveBackground(){
  const input = document.getElementById("bgUrl");
  const url = (input.value || "").trim();
  if(!url) return;

  if(bgErrEl) bgErrEl.textContent = "";

  try{
    const { error } = await sb
      .from("couple_settings")
      .upsert({ couple_id: COUPLE_ID, background_url: url });

    if(error) throw error;

    await loadBackground(); // ä¿å­˜å¾Œã™ãåæ˜ 
    input.value = "";
  }catch(err){
    if(bgErrEl) bgErrEl.textContent = "èƒŒæ™¯ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err));
  }
}
/* ===== è¨˜å¿µæ—¥ï¼ˆ27æ—¥ã®ã¿è¡¨ç¤ºï¼‰ ===== */
function renderAnniversary(){
  const now = new Date();
  if(now.getDate() !== 27){
    annivCard.style.display="none";
    return;
  }
  const days = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - START_DATE) / 86400000);

  let years = now.getFullYear() - START_DATE.getFullYear();
  let months = now.getMonth() - START_DATE.getMonth();
  if(months < 0){ years -= 1; months += 12; }

  if(now.getDate() < START_DATE.getDate()){
    months -= 1;
    if(months < 0){ months = 11; years -= 1; }
  }

  const milestones = [500,1000,1500,2000,2500,3000];
  const isMilestone = milestones.includes(days);

  annivText.textContent =
    `ğŸ‰ è¨˜å¿µæ—¥ï¼šä»˜ãåˆã£ã¦ ${years}å¹´${months}ãƒ¶æœˆï¼ˆ${days}æ—¥ï¼‰` + (isMilestone ? " ğŸŠ" : "");

  annivCard.style.display="block";
}

/* ===== æŒã¡è¶Šã—ï¼ˆæœªå®Œäº†ã®éå»æ—¥â†’ä»Šæ—¥ï¼‰ ===== */
async function carryOverOverdue(){
  const today = todayISO();
  const { error } = await sb
    .from("todos")
    .update({ due_date: today })
    .eq("couple_id", COUPLE_ID)
    .eq("done", false)
    .lt("due_date", today);
  if(error) throw error;
}

/* ===== æœˆToDoå–å¾— ===== */
async function fetchMonthTodos(y, m){
  const start = new Date(y, m, 1);
  const end = new Date(y, m+1, 0);
  const { data, error } = await sb
    .from("todos")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .gte("due_date", toISO(start))
    .lte("due_date", toISO(end))
    .order("due_date", { ascending:true })
    .order("created_at", { ascending:false });
  if(error) throw error;
  return data || [];
}

/* ===== ãƒ­ãƒ¼ã‚«ãƒ«AIï¼šæ—¥ä»˜ï¼‹æ™‚é–“ï¼ˆ4æ—¥8æ™‚å¯¾å¿œï¼‰ ===== */
function localAIParse(input){
  let s = (input || "").trim();
  const now = new Date();
  const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let due = new Date(today0);
  let time = "";
  let m;

  // æ™‚åˆ»
  if((m = s.match(/(\d{1,2})(?:æ™‚|:)(\d{2})?/))){
    const h = Number(m[1]);
    const mm = m[2] ? Number(m[2]) : 0;
    if(h>=0 && h<=23 && mm>=0 && mm<=59){
      time = `${pad2(h)}:${pad2(mm)}`;
      s = s.replace(m[0], " ").trim();
    }
  }

  // ç›¸å¯¾
  if(/æ˜å¾Œæ—¥/.test(s)){ due.setDate(due.getDate()+2); s = s.replace("æ˜å¾Œæ—¥"," "); }
  else if(/æ˜æ—¥/.test(s)){ due.setDate(due.getDate()+1); s = s.replace("æ˜æ—¥"," "); }
  else if(/ä»Šæ—¥/.test(s)){ s = s.replace("ä»Šæ—¥"," "); }

  // å¹´æœˆæ—¥
  if((m = s.match(/(20\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})/))){
    due = new Date(+m[1], +m[2]-1, +m[3]);
    s = s.replace(m[0]," ").trim();
  }
  // æœˆæ—¥
  else if((m = s.match(/(\d{1,2})[\/\-](\d{1,2})/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // ã€Œ1æœˆ4æ—¥ã€
  else if((m = s.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/))){
    let y = now.getFullYear();
    const cand = new Date(y, +m[1]-1, +m[2]);
    due = (cand < today0) ? new Date(y+1, +m[1]-1, +m[2]) : cand;
    s = s.replace(m[0]," ").trim();
  }
  // ã€Œ4æ—¥ã€
  else if((m = s.match(/(\d{1,2})æ—¥/))){
    const day = +m[1];
    let y = now.getFullYear();
    let mon = now.getMonth();
    let cand = new Date(y, mon, day);
    if(cand < today0){
      mon += 1;
      if(mon > 11){ mon = 0; y += 1; }
      cand = new Date(y, mon, day);
    }
    due = cand;
    s = s.replace(m[0]," ").trim();
  }

  let title = s.replace(/\s+/g," ").trim();
  if(!title) title = "ToDo";
  return { title, due_date: toISO(due), due_time: time };
}

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ===== */
function groupByDate(todos){
  const map = new Map();
  for(const t of todos){
    if(!map.has(t.due_date)) map.set(t.due_date, []);
    map.get(t.due_date).push(t);
  }
  return map;
}

function buildCalendar(){
  calendarGridEl.innerHTML = "";
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(h=>{
    const el = document.createElement("div");
    el.className="calHead";
    el.textContent=h;
    calendarGridEl.appendChild(el);
  });

  monthLabelEl.textContent = `${viewYear}å¹´ ${viewMonth+1}æœˆ`;
  selectedLabelEl.textContent = `é¸æŠï¼š${selectedISO}`;

  const first = new Date(viewYear, viewMonth, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
  const byDate = groupByDate(monthTodos);
  const tISO = todayISO();

  for(let i=0;i<startDow;i++) calendarGridEl.appendChild(document.createElement("div"));

  for(let day=1; day<=daysInMonth; day++){
    const iso = `${viewYear}-${pad2(viewMonth+1)}-${pad2(day)}`;
    const cell = document.createElement("div");
    cell.className = "calCell";
    if(iso === tISO) cell.classList.add("calToday");
    if(iso === selectedISO) cell.classList.add("calSelected");

    const num = document.createElement("div");
    num.className="calNum";
    num.textContent = day;

    const items = (byDate.get(iso) || []).filter(x=>!x.done);
    const meta = document.createElement("div");
    meta.className="calMeta";
    meta.textContent = items.length ? `æœªå®Œäº† ${items.length}ä»¶` : " ";

    const dots = document.createElement("div");
    dots.className="dots";
    items.slice(0,6).forEach(()=> {
      const d = document.createElement("span");
      d.className="dot";
      dots.appendChild(d);
    });

    cell.appendChild(num);
    cell.appendChild(meta);
    cell.appendChild(dots);

    cell.addEventListener("click", ()=>{
      selectedISO = iso;
      dueDateEl.value = iso;
      renderDayList();
      buildCalendar();
    });

    calendarGridEl.appendChild(cell);
  }
}

function renderDayList(){
  dayLabelEl.textContent = `${selectedISO} ã®ToDo`;
  todoListEl.innerHTML = "";

  const items = monthTodos.filter(t => t.due_date === selectedISO);
  if(items.length === 0){
    const li = document.createElement("li");
    li.className="muted";
    li.textContent="ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“";
    todoListEl.appendChild(li);
    return;
  }

  items.forEach(t=>{
    const li = document.createElement("li");
    li.className = t.done ? "done" : "";
    const time = (t.due_time || "").trim();
    const timeLabel = time ? `ï¼ˆ${time}ï¼‰` : "";

    li.innerHTML = `
      <label style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" ${t.done ? "checked":""} />
        <span style="flex:1">${escapeHtml(t.title)} <span class="muted">${escapeHtml(timeLabel)}</span></span>
        <button type="button" class="sub">å‰Šé™¤</button>
      </label>
    `;

    li.querySelector("input").addEventListener("change", async (e)=>{
      setError("");
      const { error } = await sb.from("todos").update({ done: e.target.checked }).eq("id", t.id);
      if(error){ setError(error.message); return; }
      await reloadMonth();
    });

    li.querySelector("button").addEventListener("click", async ()=>{
      setError("");
      const { error } = await sb.from("todos").delete().eq("id", t.id);
      if(error){ setError(error.message); return; }
      await reloadMonth();
    });

    todoListEl.appendChild(li);
  });
}

async function reloadMonth(){
  setError("");
  try{
    setStatus("åŒæœŸä¸­â€¦");
    await carryOverOverdue();
    monthTodos = await fetchMonthTodos(viewYear, viewMonth);
    setStatus("OK");
    buildCalendar();
    renderDayList();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
}

/* ===== æ—¥è¨˜ ===== */
async function fetchDiary(dateISO){
  const { data, error } = await sb
    .from("diaries")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .eq("date", dateISO)
    .order("created_at", { ascending:false })
    .limit(1);
  if(error) throw error;
  return (data && data[0]) || null;
}

async function insertDiary(dateISO, title, body){
  const { error } = await sb
    .from("diaries")
    .insert([{ couple_id: COUPLE_ID, date: dateISO, title, body,tags}]);
  if(error) throw error;
}

async function deleteDiaryById(id){
  const { error } = await sb.from("diaries").delete().eq("id", id);
  if(error) throw error;
}

async function listRecentDiaries(){
  const { data, error } = await sb
    .from("diaries")
    .select("*")
    .eq("couple_id", COUPLE_ID)
    .order("created_at", { ascending:false })
    .limit(7);
  if(error) throw error;
  return data || [];
}

async function renderDiaryList(){
  diaryListEl.innerHTML = "";
  const items = await listRecentDiaries();
  items.forEach(it=>{
    const li = document.createElement("li");
    li.style.cursor = "pointer";
    li.innerHTML = `<b>${it.date}</b>ï¼š${escapeHtml(it.title || "ç„¡é¡Œ")} <span class="muted">(${new Date(it.created_at).toLocaleString()})</span>`;
    li.addEventListener("click", ()=>{
      diaryDateEl.value = it.date;
      loadDiary();
    });
    diaryListEl.appendChild(li);
  });
}

async function loadDiary(){
  const dateISO = diaryDateEl.value || todayISO();
  diaryDateEl.value = dateISO;

  try{
    setDiaryError(""); setDiaryStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const d = await fetchDiary(dateISO);
    if(!d){
      currentDiaryId = null;
      diaryTitleEl.value = "";
      diaryBodyEl.value = "";
      setDiaryStatus("ã“ã®æ—¥ã®æ—¥è¨˜ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
    }else{
      currentDiaryId = d.id;
      diaryTitleEl.value = d.title || "";
      diaryBodyEl.value = d.body || "";
      setDiaryStatus("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    }
    await renderDiaryList();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("æ—¥è¨˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

async function saveDiary(){
  const dateISO = diaryDateEl.value || todayISO();
  diaryDateEl.value = dateISO;

  const title = (diaryTitleEl.value || "").trim() || "ç„¡é¡Œ";
  const body = (diaryBodyEl.value || "").trim();
  if(!body){ setDiaryError("æœ¬æ–‡ãŒç©ºã§ã™"); return; }
  const tags = (document.getElementById("diaryTags").value || "")
  .split(",").map(s=>s.trim()).filter(Boolean);

  try{
    setDiaryError(""); setDiaryStatus("ä¿å­˜ä¸­â€¦");
    await insertDiary(dateISO, title, body);
    setDiaryStatus("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    await loadDiary();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

async function deleteDiary(){
  if(!currentDiaryId){ setDiaryError("å‰Šé™¤ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  try{
    setDiaryError(""); setDiaryStatus("å‰Šé™¤ä¸­â€¦");
    await deleteDiaryById(currentDiaryId);
    currentDiaryId = null;
    diaryTitleEl.value = "";
    diaryBodyEl.value = "";
    setDiaryStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    await renderDiaryList();
  }catch(err){
    setDiaryStatus("");
    setDiaryError("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š" + (err.message || String(err)));
  }
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
aiBtn.addEventListener("click", ()=>{
  const raw = (txtEl.value || "").trim();
  if(!raw) return;
  const p = localAIParse(raw);
  txtEl.value = p.title;
  dueDateEl.value = p.due_date;
  dueTimeEl.value = p.due_time;
});

addBtn.addEventListener("click", async ()=>{
  const raw = (txtEl.value || "").trim();
  if(!raw){ setError("ToDoãŒç©ºã§ã™"); return; }

  // â˜…æ•´å½¢æŠ¼ã—å¿˜ã‚Œã§ã‚‚å¿…ãšè§£æ
  const p = localAIParse(raw);

  const due = (dueDateEl.value || p.due_date);
  const time = (dueTimeEl.value || p.due_time);

  setError("");
  try{
    setStatus("è¿½åŠ ä¸­â€¦");
    const { error } = await sb.from("todos").insert([{
      couple_id: COUPLE_ID,
      title: p.title,
      due_date: due,
      due_time: time || null,
      done: false
    }]);
    if(error) throw error;

    txtEl.value = "";
    dueTimeEl.value = "";
    selectedISO = due;
    dueDateEl.value = due;

    const d = fromISO(due);
    viewYear = d.getFullYear();
    viewMonth = d.getMonth();

    await reloadMonth();
  }catch(err){
    setStatus("");
    setError(err.message || String(err));
  }
});

prevBtn.addEventListener("click", async ()=>{
  viewMonth -= 1;
  if(viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
  selectedISO = `${viewYear}-${pad2(viewMonth+1)}-01`;
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

nextBtn.addEventListener("click", async ()=>{
  viewMonth += 1;
  if(viewMonth > 11){ viewMonth = 0; viewYear += 1; }
  selectedISO = `${viewYear}-${pad2(viewMonth+1)}-01`;
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

thisMonthBtn.addEventListener("click", async ()=>{
  const t = new Date();
  viewYear = t.getFullYear();
  viewMonth = t.getMonth();
  selectedISO = todayISO();
  dueDateEl.value = selectedISO;
  await reloadMonth();
});

logoutBtn.addEventListener("click", ()=>{
  localStorage.removeItem("couple_id");
  location.reload();
});

clearCouple.addEventListener("click", ()=>{
  localStorage.removeItem("couple_id");
  location.reload();
});

/* æ—¥è¨˜ã‚¤ãƒ™ãƒ³ãƒˆ */
loadDiaryBtn.addEventListener("click", loadDiary);
saveDiaryBtn.addEventListener("click", saveDiary);
deleteDiaryBtn.addEventListener("click", deleteDiary);

/* ===== init ===== */
(function init(){
  if(!COUPLE_ID){
    loginCard.style.display="block";
    app.style.display="none";

    saveCouple.addEventListener("click", ()=>{
      const v = (coupleInput.value || "").trim();
      if(!v){ loginErr.textContent = "å…±æœ‰IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      localStorage.setItem("couple_id", v);
      location.reload();
    });

    return;
  }

  loginCard.style.display="none";
  app.style.display="block";
  // èƒŒæ™¯ã‚’èª­ã¿è¾¼ã¿
loadBackground();

// ä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("saveBg").addEventListener("click", saveBackground);

  renderAnniversary();

  const t = new Date();
  viewYear = t.getFullYear();
  viewMonth = t.getMonth();
  selectedISO = todayISO();
  dueDateEl.value = selectedISO;

  diaryDateEl.value = todayISO();
  renderDiaryList();
  loadDiary();

  reloadMonth();
})();
</script>
</body>
</html>
