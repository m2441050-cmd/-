<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple OS（ToDo＋日記）</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;max-width:860px;margin:36px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px}
    small{color:#666}
    .card{border:1px solid #ddd;border-radius:14px;padding:12px;margin-top:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input, textarea{padding:10px;border:1px solid #ccc;border-radius:10px}
    input[type="text"]{flex:1;min-width:220px}
    textarea{width:100%;min-height:96px;resize:vertical}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    ul{padding-left:18px;margin:10px 0}
    li{margin:8px 0}
    .done{text-decoration:line-through;opacity:.6}
    .muted{opacity:.7}
    .err{color:#b00020}
    .cardSub{border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Couple OS（共有ToDo＋日記 / MVP）</h1>
  <small class="muted">※このページは「あなた達2人専用」。合言葉は固定です。</small>

  <div class="grid">
    <!-- ToDo -->
    <div class="card">
      <h2>ToDo</h2>
      <div class="row">
        <input id="txt" type="text" placeholder="ToDoを入力" />
        <button id="add">追加</button>
        <button id="reload">更新</button>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="status" class="muted"></small>
        <small id="error" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">21:00 未完了一覧（ページ内）</h2>
        <small id="summaryGate" class="muted"></small>
        <ul id="summaryList"></ul>
      </div>

      <ul id="list"></ul>
    </div>

    <!-- Diary -->
    <div class="card">
      <h2>日記</h2>
      <div class="row">
        <label class="muted">日付</label>
        <input id="diaryDate" type="date" />
        <button id="loadDiary">表示</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="diaryTitle" type="text" placeholder="タイトル（空なら自動で「無題」）" />
      </div>
      <div style="margin-top:10px">
        <textarea id="diaryBody" placeholder="本文"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveDiary">保存</button>
        <button id="deleteDiary">削除</button>
      </div>
      <div class="row" style="margin-top:8px">
        <small id="diaryStatus" class="muted"></small>
        <small id="diaryError" class="err"></small>
      </div>

      <div class="cardSub">
        <h2 style="margin:0 0 6px">最近の日記</h2>
        <ul id="diaryList"></ul>
      </div>
    </div>
  </div>

  <script>
    // ===== 固定合言葉（あなた達2人だけ）=====
    const COUPLE_ID = "kentaria";

    // ===== Supabase設定 =====
    const SUPABASE_URL = "https://eycneuftjdooykzjbioy.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_ySwVIipmFAvN6VGexnR0PQ_RDsZ4M2Z";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== ToDo =====
    const txt = document.getElementById("txt");
    const addBtn = document.getElementById("add");
    const reloadBtn = document.getElementById("reload");
    const list = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const summaryGate = document.getElementById("summaryGate");
    const summaryList = document.getElementById("summaryList");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setError(msg){ errorEl.textContent = msg || ""; }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    async function fetchTodos(){
      const { data, error } = await sb
        .from("todos")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .order("created_at", { ascending: false });
      if(error) throw error;
      return data || [];
    }
    async function addTodo(title){
      const { error } = await sb
        .from("todos")
        .insert([{ couple_id: COUPLE_ID, title, done: false }]);
      if(error) throw error;
    }
    async function toggleTodo(id, done){
      const { error } = await sb.from("todos").update({ done }).eq("id", id);
      if(error) throw error;
    }
    async function deleteTodo(id){
      const { error } = await sb.from("todos").delete().eq("id", id);
      if(error) throw error;
    }

    function isAfter21(){
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      return (h > 21) || (h === 21 && m >= 0);
    }

    function renderSummary(items){
      summaryList.innerHTML = "";
      const gate = isAfter21();
      summaryGate.textContent = gate ? "21:00以降：未完了を表示中" : "21:00前：ここは空のまま";
      if(!gate) return;

      const open = items.filter(x => !x.done);
      if(open.length === 0){
        const li = document.createElement("li");
        li.textContent = "未完了はありません";
        summaryList.appendChild(li);
        return;
      }
      open.slice(0, 7).forEach(it => {
        const li = document.createElement("li");
        li.textContent = it.title;
        summaryList.appendChild(li);
      });
      if(open.length > 7){
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = `ほか ${open.length - 7} 件…`;
        summaryList.appendChild(li);
      }
    }

    async function renderTodos(){
      setError("");
      list.innerHTML = "";
      summaryList.innerHTML = "";
      try{
        setStatus("読み込み中…");
        const items = await fetchTodos();
        setStatus(`件数：${items.length}`);
        renderSummary(items);

        items.forEach(it => {
          const li = document.createElement("li");
          li.className = it.done ? "done" : "";
          li.innerHTML = `
            <label style="display:flex;gap:10px;align-items:center">
              <input type="checkbox" ${it.done ? "checked":""} />
              <span style="flex:1">${escapeHtml(it.title)}</span>
              <button>削除</button>
            </label>
          `;
          li.querySelector("input").addEventListener("change", async (e)=>{
            try{ await toggleTodo(it.id, e.target.checked); renderAll(); }
            catch(err){ setError(err.message || String(err)); }
          });
          li.querySelector("button").addEventListener("click", async ()=>{
            try{ await deleteTodo(it.id); renderAll(); }
            catch(err){ setError(err.message || String(err)); }
          });
          list.appendChild(li);
        });
      }catch(err){
        setStatus("");
        setError("ToDo保存/取得エラー：" + (err.message || String(err)));
      }
    }

    async function onAdd(){
      const v = (txt.value || "").trim();
      if(!v) return;
      try{
        setError(""); setStatus("追加中…");
        await addTodo(v);
        txt.value = "";
        renderAll();
      }catch(err){
        setStatus("");
        setError("追加エラー：" + (err.message || String(err)));
      }
    }

    // ===== Diary =====
    const diaryDate = document.getElementById("diaryDate");
    const diaryTitle = document.getElementById("diaryTitle");
    const diaryBody = document.getElementById("diaryBody");
    const loadDiaryBtn = document.getElementById("loadDiary");
    const saveDiaryBtn = document.getElementById("saveDiary");
    const deleteDiaryBtn = document.getElementById("deleteDiary");
    const diaryStatus = document.getElementById("diaryStatus");
    const diaryError = document.getElementById("diaryError");
    const diaryList = document.getElementById("diaryList");

    function setDiaryStatus(msg){ diaryStatus.textContent = msg || ""; }
    function setDiaryError(msg){ diaryError.textContent = msg || ""; }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function fetchDiary(date){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .eq("date", date)
        .order("created_at", { ascending: false })
        .limit(1);
      if(error) throw error;
      return (data && data[0]) || null;
    }

    async function insertDiary(date, title, body){
      const { error } = await sb
        .from("diaries")
        .insert([{ couple_id: COUPLE_ID, date, title, body }]);
      if(error) throw error;
    }

    async function deleteDiaryById(id){
      const { error } = await sb.from("diaries").delete().eq("id", id);
      if(error) throw error;
    }

    async function listRecentDiaries(){
      const { data, error } = await sb
        .from("diaries")
        .select("*")
        .eq("couple_id", COUPLE_ID)
        .order("created_at", { ascending: false })
        .limit(7);
      if(error) throw error;
      return data || [];
    }

    let currentDiaryId = null;

    async function loadDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      try{
        setDiaryError(""); setDiaryStatus("読み込み中…");
        const d = await fetchDiary(date);
        if(!d){
          currentDiaryId = null;
          diaryTitle.value = "";
          diaryBody.value = "";
          setDiaryStatus("この日の記録はまだありません。");
        }else{
          currentDiaryId = d.id;
          diaryTitle.value = d.title;
          diaryBody.value = d.body;
          setDiaryStatus("読み込みました。");
        }
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("日記エラー：" + (err.message || String(err)));
      }
    }

    async function saveDiary(){
      const date = diaryDate.value || todayISO();
      diaryDate.value = date;

      const title = (diaryTitle.value || "").trim() || "無題";
      const body = (diaryBody.value || "").trim();
      if(!body){ setDiaryError("本文が空です"); return; }

      try{
        setDiaryError(""); setDiaryStatus("保存中…");
        await insertDiary(date, title, body);
        setDiaryStatus("保存しました。");
        await loadDiary();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("保存エラー：" + (err.message || String(err)));
      }
    }

    async function deleteDiary(){
      if(!currentDiaryId){ setDiaryError("削除する日記がありません"); return; }
      try{
        setDiaryError(""); setDiaryStatus("削除中…");
        await deleteDiaryById(currentDiaryId);
        currentDiaryId = null;
        diaryTitle.value = "";
        diaryBody.value = "";
        setDiaryStatus("削除しました。");
        await renderDiaryList();
      }catch(err){
        setDiaryStatus("");
        setDiaryError("削除エラー：" + (err.message || String(err)));
      }
    }

    async function renderDiaryList(){
      diaryList.innerHTML = "";
      const items = await listRecentDiaries();
      items.forEach(it => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${it.date}</b>：${escapeHtml(it.title)} <span class="muted">(${new Date(it.created_at).toLocaleString()})</span>`;
        li.style.cursor = "pointer";
        li.addEventListener("click", ()=>{
          diaryDate.value = it.date;
          loadDiary();
        });
        diaryList.appendChild(li);
      });
    }

    async function renderAll(){
      await renderTodos();
      await renderDiaryList();
    }

    // events
    addBtn.addEventListener("click", onAdd);
    reloadBtn.addEventListener("click", renderAll);
    txt.addEventListener("keydown", (e)=>{ if(e.key === "Enter") onAdd(); });

    loadDiaryBtn.addEventListener("click", loadDiary);
    saveDiaryBtn.addEventListener("click", saveDiary);
    deleteDiaryBtn.addEventListener("click", deleteDiary);

    // init
    diaryDate.value = todayISO();
    renderAll();
  </script>
</body>
</html>
